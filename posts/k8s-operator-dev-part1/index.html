<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="K8s Operator å¼€å‘ï¼ˆä¸€ï¼‰ï¼šæ¦‚è¿°">
<meta property="og:description" content="Operator æ§åˆ¶å™¨ K8s å®šä¹‰äº†å¾ˆå¤šæŠ½è±¡å†…éƒ¨èµ„æºæ¥æè¿°ä¸åŒå·¥ä½œè´Ÿè½½ç±»å‹ï¼Œæ¯”å¦‚ Deployment ç”¨äºæ— çŠ¶æ€åº”ç”¨1éƒ¨ç½²ã€StatefulSet ç”¨äºæœ‰çŠ¶æ€åº”ç”¨ã€CronJob é€‚ç”¨äºè¿è¡Œå®šæ—¶ä»»åŠ¡ã€‚
 Deployment å’Œ StatefulSet çš„åŒºåˆ«2ï¼š
 Deployment åˆ›å»ºçš„ Pod ä¹‹é—´æ²¡æœ‰é¡ºåºï¼ŒæœåŠ¡é€šè¿‡ Service çš„ Service IP æš´éœ²ã€‚Deployment ä¹Ÿå¯ä»¥ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨å·å®ç°æœ‰çŠ¶æ€åº”ç”¨éƒ¨ç½²ï¼Œä½†æœ‰ä½¿ç”¨é™åˆ¶ã€‚Deployment åªæ”¯æŒé€šè¿‡ .spec.template.spec.volumes.persistentVolumeClaim å¼•ç”¨ä¸€ä¸ª PVCï¼ˆæå‰åˆ›å»ºï¼‰ã€‚å¦‚æœè¯¥ PVC è®¿é—®æ¨¡å¼æ”¯æŒä¸”è®¾ç½®ä¸º RWOï¼ŒDeployment å‰¯æœ¬æ•°é‡å¿…é¡»ä¸º 1ï¼ˆå• Podï¼‰ï¼›å¦åˆ™ï¼Œä½¿ç”¨ RWX æ¨¡å¼ï¼Œå¤šä¸ª Pod å…±äº«å­˜å‚¨ã€‚ StatefulSetï¼šæ¯ä¸ª Pod æœ‰è‡ªå·±çš„å­˜å‚¨ï¼Œé€šè¿‡ .spec.volumeClaimTemplates ä¸ºæ¯ä¸ª Pod åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ PV ä¿å­˜å…¶æ•°æ®å’ŒçŠ¶æ€ã€‚å³ä½¿åˆ é™¤ StatefulSet æˆ– Pod å®•æœºï¼Œåˆ›å»ºçš„ PVC ä»ä¿ç•™å…¶æ•°æ®å¹¶å¯ä»¥åœ¨ Pod æ¢å¤åé‡æ–°æ¢å¤ç»‘å®šã€‚StatefulSet å’Œæ— å¤´æœåŠ¡é…åˆä½¿ç”¨ï¼ˆ.spec.clusterIP=Noneï¼‰ï¼Œæ— å¤´æœåŠ¡ä¸åšè´Ÿè½½å‡è¡¡ï¼Œè¿”å›æ‰€æœ‰å…³è” Pod çš„ IP åœ°å€åˆ—è¡¨ã€‚   è¿™äº› K8s å†…éƒ¨èµ„æºçš„çŠ¶æ€ç”±å¯¹åº”èµ„æºçš„æ§åˆ¶å™¨æ¥ç»´æŠ¤ï¼Œæ¯”å¦‚ Deployment å¯¹åº” Deployment Controllerã€‚K8s æ§åˆ¶ç»„ä»¶ kube-controller-manager åŒ…å«äº†æ‰€æœ‰å†…éƒ¨èµ„æºæ§åˆ¶å™¨ã€‚æ§åˆ¶å™¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ§åˆ¶å›è·¯ï¼ˆcontrol loopï¼‰æ— é™å¾ªç¯è¿›ç¨‹ï¼ŒWatch èµ„æºçŠ¶æ€ï¼Œå¹¶åšå‡ºç›¸åº”è°ƒæ•´ï¼Œè°ƒåå½“å‰çŠ¶æ€ï¼ˆstatusï¼‰è‡³æœŸæœ›çŠ¶æ€ï¼ˆspecï¼‰ï¼Œå¦‚ï¼šæ»šåŠ¨æ›´æ–°ï¼Œæ¢å¤å®•æœºçš„ Podã€‚å¯¹äºè¿è¡Œåœ¨ Pod ä¸­çš„ç¨‹åºï¼Œå¦‚ä¸‹å›¾3ä¸­çš„ DB å’Œ Web ç¨‹åºï¼Œä»–ä»¬æœ¬èº«å¹¶æ— æ„ŸçŸ¥è‡ªèº«è¿è¡Œåœ¨ K8s ç¯å¢ƒä¸­ã€‚åº”ç”¨è¿ç»´ç”± K8s æ§åˆ¶å™¨æ¥å®Œæˆã€‚">
<meta property="og:type" content="article">
<meta property="og:url" content="https://huanggze.github.io/posts/k8s-operator-dev-part1/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-01-15T21:20:28+08:00">
<meta property="article:modified_time" content="2022-01-15T21:20:28+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="K8s Operator å¼€å‘ï¼ˆä¸€ï¼‰ï¼šæ¦‚è¿°">
<meta name=twitter:description content="Operator æ§åˆ¶å™¨ K8s å®šä¹‰äº†å¾ˆå¤šæŠ½è±¡å†…éƒ¨èµ„æºæ¥æè¿°ä¸åŒå·¥ä½œè´Ÿè½½ç±»å‹ï¼Œæ¯”å¦‚ Deployment ç”¨äºæ— çŠ¶æ€åº”ç”¨1éƒ¨ç½²ã€StatefulSet ç”¨äºæœ‰çŠ¶æ€åº”ç”¨ã€CronJob é€‚ç”¨äºè¿è¡Œå®šæ—¶ä»»åŠ¡ã€‚
 Deployment å’Œ StatefulSet çš„åŒºåˆ«2ï¼š
 Deployment åˆ›å»ºçš„ Pod ä¹‹é—´æ²¡æœ‰é¡ºåºï¼ŒæœåŠ¡é€šè¿‡ Service çš„ Service IP æš´éœ²ã€‚Deployment ä¹Ÿå¯ä»¥ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨å·å®ç°æœ‰çŠ¶æ€åº”ç”¨éƒ¨ç½²ï¼Œä½†æœ‰ä½¿ç”¨é™åˆ¶ã€‚Deployment åªæ”¯æŒé€šè¿‡ .spec.template.spec.volumes.persistentVolumeClaim å¼•ç”¨ä¸€ä¸ª PVCï¼ˆæå‰åˆ›å»ºï¼‰ã€‚å¦‚æœè¯¥ PVC è®¿é—®æ¨¡å¼æ”¯æŒä¸”è®¾ç½®ä¸º RWOï¼ŒDeployment å‰¯æœ¬æ•°é‡å¿…é¡»ä¸º 1ï¼ˆå• Podï¼‰ï¼›å¦åˆ™ï¼Œä½¿ç”¨ RWX æ¨¡å¼ï¼Œå¤šä¸ª Pod å…±äº«å­˜å‚¨ã€‚ StatefulSetï¼šæ¯ä¸ª Pod æœ‰è‡ªå·±çš„å­˜å‚¨ï¼Œé€šè¿‡ .spec.volumeClaimTemplates ä¸ºæ¯ä¸ª Pod åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ PV ä¿å­˜å…¶æ•°æ®å’ŒçŠ¶æ€ã€‚å³ä½¿åˆ é™¤ StatefulSet æˆ– Pod å®•æœºï¼Œåˆ›å»ºçš„ PVC ä»ä¿ç•™å…¶æ•°æ®å¹¶å¯ä»¥åœ¨ Pod æ¢å¤åé‡æ–°æ¢å¤ç»‘å®šã€‚StatefulSet å’Œæ— å¤´æœåŠ¡é…åˆä½¿ç”¨ï¼ˆ.spec.clusterIP=Noneï¼‰ï¼Œæ— å¤´æœåŠ¡ä¸åšè´Ÿè½½å‡è¡¡ï¼Œè¿”å›æ‰€æœ‰å…³è” Pod çš„ IP åœ°å€åˆ—è¡¨ã€‚   è¿™äº› K8s å†…éƒ¨èµ„æºçš„çŠ¶æ€ç”±å¯¹åº”èµ„æºçš„æ§åˆ¶å™¨æ¥ç»´æŠ¤ï¼Œæ¯”å¦‚ Deployment å¯¹åº” Deployment Controllerã€‚K8s æ§åˆ¶ç»„ä»¶ kube-controller-manager åŒ…å«äº†æ‰€æœ‰å†…éƒ¨èµ„æºæ§åˆ¶å™¨ã€‚æ§åˆ¶å™¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ§åˆ¶å›è·¯ï¼ˆcontrol loopï¼‰æ— é™å¾ªç¯è¿›ç¨‹ï¼ŒWatch èµ„æºçŠ¶æ€ï¼Œå¹¶åšå‡ºç›¸åº”è°ƒæ•´ï¼Œè°ƒåå½“å‰çŠ¶æ€ï¼ˆstatusï¼‰è‡³æœŸæœ›çŠ¶æ€ï¼ˆspecï¼‰ï¼Œå¦‚ï¼šæ»šåŠ¨æ›´æ–°ï¼Œæ¢å¤å®•æœºçš„ Podã€‚å¯¹äºè¿è¡Œåœ¨ Pod ä¸­çš„ç¨‹åºï¼Œå¦‚ä¸‹å›¾3ä¸­çš„ DB å’Œ Web ç¨‹åºï¼Œä»–ä»¬æœ¬èº«å¹¶æ— æ„ŸçŸ¥è‡ªèº«è¿è¡Œåœ¨ K8s ç¯å¢ƒä¸­ã€‚åº”ç”¨è¿ç»´ç”± K8s æ§åˆ¶å™¨æ¥å®Œæˆã€‚">
<meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff">
<meta name=theme-color media="(prefers-color-scheme: dark)" content="#262d33">
<title>
Hi Folks - K8s Operator å¼€å‘ï¼ˆä¸€ï¼‰ï¼šæ¦‚è¿°
</title><link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel=stylesheet>
<link rel=stylesheet href=/minima.1646894794.css>
<script defer type=text/javascript src=/minima.1646894794.js></script>
</head><script>try{"theme"in localStorage||(localStorage.theme=window.matchMedia("(prefer-color-scheme: dark)").matches?"dark":"light"),document.querySelector("html").classList.add(localStorage.theme)}catch(e){console.error(e)}</script>
<body class="sm:mx-5 sm:my-0">
<header class="flex justify-between items-center mb-6 sm:my-3">
<div class="flex items-center">
<div id=theme-switcher class="text-4xl cursor-pointer">ğŸŒ</div></div><nav class="flex items-center
whitespace-nowrap overflow-x-auto overflow-y-hidden">
<a class=ml-5 href=/>Home</a>
<a class=ml-5 href=/categories>Categories</a>
<a class=ml-5 href=/series>Series</a>
<a class=ml-5 href=/about>About</a>
</nav></header><details class="toc toc-lines">
<summary></summary>
<div class=pb-1>
<nav id=TableOfContents>
<ul>
<li><a href=#operator-æ§åˆ¶å™¨>Operator æ§åˆ¶å™¨</a></li><li><a href=#kubebuilder>Kubebuilder</a>
<ul>
<li><a href=#åˆå§‹åŒ–é¡¹ç›®>åˆå§‹åŒ–é¡¹ç›®</a></li><li><a href=#æµ‹è¯•éƒ¨ç½²>æµ‹è¯•éƒ¨ç½²</a></li><li><a href=#å®šä¹‰è‡ªå®šä¹‰èµ„æº>å®šä¹‰è‡ªå®šä¹‰èµ„æº</a></li><li><a href=#ç¼–å†™æ§åˆ¶å™¨>ç¼–å†™æ§åˆ¶å™¨</a></li><li><a href=#éƒ¨ç½²ä¸-rbac>éƒ¨ç½²ä¸ RBAC</a></li></ul></li></ul></nav></div></details>
<h1 class="mt-6 mb-6">K8s Operator å¼€å‘ï¼ˆä¸€ï¼‰ï¼šæ¦‚è¿°</h1><div class="mb-3 text-xs flex justify-between sm:flex-col">
<div>
Posted at &mdash; Jan 15, 2022
</div></div><main>
<p></p><article class=md>
<h2 id=operator-æ§åˆ¶å™¨>Operator æ§åˆ¶å™¨</h2><p>K8s å®šä¹‰äº†å¾ˆå¤šæŠ½è±¡å†…éƒ¨èµ„æºæ¥æè¿°ä¸åŒå·¥ä½œè´Ÿè½½ç±»å‹ï¼Œæ¯”å¦‚ Deployment ç”¨äºæ— çŠ¶æ€åº”ç”¨<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>éƒ¨ç½²ã€StatefulSet ç”¨äºæœ‰çŠ¶æ€åº”ç”¨ã€CronJob é€‚ç”¨äºè¿è¡Œå®šæ—¶ä»»åŠ¡ã€‚</p><blockquote>
<p>Deployment å’Œ StatefulSet çš„åŒºåˆ«<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>ï¼š</p><ul>
<li>Deployment åˆ›å»ºçš„ Pod ä¹‹é—´æ²¡æœ‰é¡ºåºï¼ŒæœåŠ¡é€šè¿‡ Service çš„ Service IP æš´éœ²ã€‚Deployment ä¹Ÿå¯ä»¥ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨å·å®ç°æœ‰çŠ¶æ€åº”ç”¨éƒ¨ç½²ï¼Œä½†æœ‰ä½¿ç”¨é™åˆ¶ã€‚Deployment åªæ”¯æŒé€šè¿‡ .spec.template.spec.volumes.persistentVolumeClaim å¼•ç”¨ä¸€ä¸ª PVCï¼ˆæå‰åˆ›å»ºï¼‰ã€‚å¦‚æœè¯¥ PVC è®¿é—®æ¨¡å¼æ”¯æŒä¸”è®¾ç½®ä¸º RWOï¼ŒDeployment å‰¯æœ¬æ•°é‡å¿…é¡»ä¸º 1ï¼ˆå• Podï¼‰ï¼›å¦åˆ™ï¼Œä½¿ç”¨ RWX æ¨¡å¼ï¼Œå¤šä¸ª Pod å…±äº«å­˜å‚¨ã€‚</li><li>StatefulSetï¼šæ¯ä¸ª Pod æœ‰è‡ªå·±çš„å­˜å‚¨ï¼Œé€šè¿‡ .spec.volumeClaimTemplates ä¸ºæ¯ä¸ª Pod åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ PV ä¿å­˜å…¶æ•°æ®å’ŒçŠ¶æ€ã€‚å³ä½¿åˆ é™¤ StatefulSet æˆ– Pod å®•æœºï¼Œåˆ›å»ºçš„ PVC ä»ä¿ç•™å…¶æ•°æ®å¹¶å¯ä»¥åœ¨ Pod æ¢å¤åé‡æ–°æ¢å¤ç»‘å®šã€‚StatefulSet å’Œæ— å¤´æœåŠ¡é…åˆä½¿ç”¨ï¼ˆ.spec.clusterIP=Noneï¼‰ï¼Œæ— å¤´æœåŠ¡ä¸åšè´Ÿè½½å‡è¡¡ï¼Œè¿”å›æ‰€æœ‰å…³è” Pod çš„ IP åœ°å€åˆ—è¡¨ã€‚</li></ul></blockquote><p>è¿™äº› K8s å†…éƒ¨èµ„æºçš„çŠ¶æ€ç”±å¯¹åº”èµ„æºçš„æ§åˆ¶å™¨æ¥ç»´æŠ¤ï¼Œæ¯”å¦‚ Deployment å¯¹åº” Deployment Controllerã€‚K8s æ§åˆ¶ç»„ä»¶ kube-controller-manager åŒ…å«äº†æ‰€æœ‰å†…éƒ¨èµ„æºæ§åˆ¶å™¨ã€‚æ§åˆ¶å™¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ§åˆ¶å›è·¯ï¼ˆcontrol loopï¼‰æ— é™å¾ªç¯è¿›ç¨‹ï¼ŒWatch èµ„æºçŠ¶æ€ï¼Œå¹¶åšå‡ºç›¸åº”è°ƒæ•´ï¼Œè°ƒåå½“å‰çŠ¶æ€ï¼ˆstatusï¼‰è‡³æœŸæœ›çŠ¶æ€ï¼ˆspecï¼‰ï¼Œå¦‚ï¼šæ»šåŠ¨æ›´æ–°ï¼Œæ¢å¤å®•æœºçš„ Podã€‚å¯¹äºè¿è¡Œåœ¨ Pod ä¸­çš„ç¨‹åºï¼Œå¦‚ä¸‹å›¾<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>ä¸­çš„ DB å’Œ Web ç¨‹åºï¼Œä»–ä»¬æœ¬èº«å¹¶æ— æ„ŸçŸ¥è‡ªèº«è¿è¡Œåœ¨ K8s ç¯å¢ƒä¸­ã€‚åº”ç”¨è¿ç»´ç”± K8s æ§åˆ¶å™¨æ¥å®Œæˆã€‚</p><p><img src=/images/k8s-operator-dev-part1-1.png alt=k8s-operator-dev-part1-1></p><p>è™½ç„¶ K8s åœ¨å®¹å™¨ç¼–æ’å’ŒåŸºç¡€è®¾æ–½å±‚åšäº†ç»Ÿä¸€çš„æŠ½è±¡ï¼Œå®ç°äº†è‡ªåŠ¨åŒ–è¿ç»´ï¼Œä½†å¯¹ç‰¹å®šåº”ç”¨è¿ç»´ä»¥åŠä¸šåŠ¡è¿ç»´ä¸Šï¼Œä»éœ€è¦äººåŠ›ä»‹å…¥ã€‚æ¯”å¦‚ï¼Œåœ¨ K8s ä¸Šå®‰è£…ã€å‡çº§ Redis é›†ç¾¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ç»„è£…å’Œæ›´æ–°å¤šä¸ª K8s èµ„æºï¼ŒåŒ…æ‹¬ï¼šConfigMapã€StatefulSetã€Service ç­‰ï¼ˆæˆ–é€šè¿‡ Helmï¼‰ã€‚æ›´å¤æ‚çš„åœºæ™¯æ˜¯å®ç°ä¸šåŠ¡è¿ç»´è‡ªåŠ¨åŒ–ï¼Œæ¯”å¦‚æ ¹æ®æ•°æ®åº“æŸä¸ªè¡¨å­—æ®µçš„æ›´æ–°ï¼Œé‡å¯å¦ä¸€ä¸ªä¸šåŠ¡åº”ç”¨ã€‚è¿™ç§åœºæ™¯å¯¹æ§åˆ¶å™¨æå‡ºäº†æ›´é«˜çš„è¦æ±‚ï¼Œè¦æ±‚æ§åˆ¶å™¨èƒ½æ‹¥æœ‰ä¸šåŠ¡è¿ç»´çŸ¥è¯†ï¼Œæ ¹æ®ç‰¹å®šä¸šåŠ¡åœºæ™¯è‡ªåŠ¨åŒ–ç®¡ç†ç›¸å…³ç»„ä»¶ã€‚Kubernetes è‡ªèº«çš„åŸºç¡€æ¨¡å‹å…ƒç´ å·²ç»æ— æ³•æ”¯æ’‘ä¸åŒä¸šåŠ¡é¢†åŸŸä¸‹å¤æ‚çš„è‡ªåŠ¨åŒ–åœºæ™¯ã€‚äºæ˜¯ï¼ŒK8s ç¤¾åŒºæå‡ºäº† Custom Resourceï¼ˆCRï¼‰å’Œ Operator çš„æ¦‚å¿µã€‚åŸºäºè‡ªå®šä¹‰èµ„æºå’Œè‡ªå®šä¹‰èµ„æºæ§åˆ¶å™¨ï¼Œæ¥æ‰©å±•åŸç”Ÿ Kubernetes çš„èƒ½åŠ›ã€‚</p><p>Operator çš„å¼€å‘è€…å¯ä»¥å°†ä¸šåŠ¡ç›¸å…³çš„è¿ç»´é€»è¾‘ç¼–å†™åˆ° Operator å’Œ CR ä¸­ï¼Œå¹¶å°† CR åº”ç”¨åˆ° K8s é›†ç¾¤ã€‚Operator æ§åˆ¶å™¨é€šè¿‡è®¿é—® K8s APIï¼Œåƒæ“ä½œ Deployment ç­‰å†…éƒ¨èµ„æºä¸€æ ·ï¼Œç›‘å¬å¯¹åº” CR çŠ¶æ€ï¼Œå¹¶åˆ›å»ºä¿®æ”¹å…¶ä»– K8s å†…éƒ¨èµ„æºæˆ–å¤–éƒ¨ä¾èµ–ã€‚å› æ­¤ï¼Œä¸åŒäºä¹‹å‰å›¾ç‰‡ä¸­æ©™è‰²æ¡†ä¸­ DB å’Œ Web åº”ç”¨ï¼ŒOperator éœ€è¦ä¸ kube-apiserver é€šä¿¡ï¼ˆC/S æ¶æ„ï¼‰ã€‚ä¸€ä¸ª Operator åº”ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª Database ç±»å‹ï¼ˆkindï¼‰çš„ CR å®ç° Database Operator å£°æ˜å¼é…ç½®çš„æ–¹å¼ä¸€é”®éƒ¨ç½²æ•°æ®åº“æœåŠ¡ã€‚</p><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Database</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mydb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>phase</span><span class=p>:</span><span class=w> </span><span class=l>Running</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=kubebuilder>Kubebuilder</h2><p>ä»å‰æ–‡æˆ‘ä»¬çŸ¥é“ï¼Œå¼€å‘ä¸€ä¸ª Operator é¦–å…ˆéœ€è¦å®šä¹‰ CR å¹¶å®Œæˆ Operator ä»£ç ã€‚K8s ç¤¾åŒºæä¾›äº† Kubebuilder å¼€å‘æ¡†æ¶ã€‚æœ¬èŠ‚ä»‹ç»å¦‚ä½•å®ç°å‰é¢æåˆ°çš„ä¸šåŠ¡è¿ç»´éœ€æ±‚ï¼Œç›‘å¬æ•°æ®åº“è¡¨å­—æ®µå˜åŒ–ï¼Œé‡å¯ä¸šåŠ¡åº”ç”¨ã€‚æˆ‘ä»¬å°†è¯¥ Operator å‘½åä¸º Autorebooterï¼Œå¹¶å®šä¹‰ RebootPolicy è‡ªå®šä¹‰èµ„æºã€‚åœ¨ RebootPolicy ä¸­å®šä¹‰ç›®æ ‡ä¸šåŠ¡åº”ç”¨å’Œæ•°æ®åº“ç›‘å¬é€»è¾‘ã€‚æ€»ä½“ä¸Šï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ª CRï¼Œä¸€ä¸ª Operatorï¼Œå¹¶éƒ¨ç½²åˆ° K8s é›†ç¾¤ä¸Šã€‚ Kubebuilder è¯¦ç»†ä½¿ç”¨æ‰‹å†Œå¯å‚è€ƒå®˜æ–¹å¼€å‘æ–‡æ¡£<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>ã€‚</p><h3 id=åˆå§‹åŒ–é¡¹ç›®>åˆå§‹åŒ–é¡¹ç›®</h3><p>å®‰è£… Kubebuilderï¼Œå½“å‰æœ€æ–°ç‰ˆæœ¬æ˜¯ v2.3.0ã€‚</p><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/<span class=k>$(</span>go env GOOS<span class=k>)</span>/<span class=k>$(</span>go env GOARCH<span class=k>)</span>
</span></span><span class=line><span class=cl>chmod +x kubebuilder <span class=o>&amp;&amp;</span> mv kubebuilder /usr/local/bin/
</span></span></code></pre></td></tr></table></div></div><p>é€šè¿‡ Kubebuilder åˆ›å»º Autorebooter Operatorï¼š</p><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> autorebooter
</span></span><span class=line><span class=cl>kubebuilder init --domain my.domain --repo my.domain/autorebooter
</span></span></code></pre></td></tr></table></div></div><p>æ¥ä¸‹æ¥ï¼Œä¸º CR å’Œ Operator æ§åˆ¶å™¨åˆ›å»ºæ¨¡æ¿ä»£ç ã€‚è¿™é‡Œé€šè¿‡ <code>kubebuilder create api</code> å‘½ä»¤åˆ›å»ºã€‚groupã€versionã€kind åˆ†åˆ«è¡¨ç¤º CR èµ„æºçš„ API ç»„ã€ç‰ˆæœ¬å’Œèµ„æºç±»å‹åç§°ã€‚åŸºæœ¬ä¸Šæ‰€æœ‰ K8s èµ„æºéƒ½æœ‰è¿™ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå¦‚ Job æ˜¯åœ¨ batch API Group ä¸‹ï¼Œæœ€æ–°çš„ç¨³å®š API ç‰ˆæœ¬æ˜¯ v1ã€‚è¯¥ API Group ä¸‹çš„å…¶ä»–èµ„æºè¿˜åŒ…æ‹¬ CronJobã€‚GVK æ˜¯ K8s æºç ä¸­çš„é‡è¦æ¦‚å¿µï¼Œä¸€ä¸ª GVK å”¯ä¸€å¯¹åº”ä¸€ç§èµ„æºç±»å‹ã€‚æˆ‘ä»¬ä¼šåœ¨æœ¬ç³»åˆ—åé¢éƒ¨åˆ†ç»§ç»­ä»‹ç»ã€‚</p><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubebuilder create api --group autoreboot --version v1alpha1 --kind RebootPolicy
</span></span></code></pre></td></tr></table></div></div><p>è¾“å…¥ä»¥ä¸Šå‘½ä»¤ï¼Œå½“æç¤ºæ˜¯å¦ <code>Create Resource [y/n]</code> ä»¥åŠ <code>Create Controller [y/n]</code> æ—¶ï¼ŒæŒ‰ y ä¼šåˆ›å»ºä»¥ä¸‹é¡¹ç›®ç»“æ„ï¼š</p><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â”œâ”€â”€ api <span class=c1># CR</span>
</span></span><span class=line><span class=cl>â”‚   â””â”€â”€ v1alpha1
</span></span><span class=line><span class=cl>â”‚       â”œâ”€â”€ groupversion_info.go
</span></span><span class=line><span class=cl>â”‚       â”œâ”€â”€ rebootpolicy_types.go <span class=c1># è‡ªå®šä¹‰èµ„æº Go ç»“æ„ä½“å£°æ˜</span>
</span></span><span class=line><span class=cl>â”‚       â””â”€â”€ zz_generated.deepcopy.go <span class=c1># è‡ªåŠ¨ç”Ÿäº§çš„ç»“æ„ä½“æ·±æ‹·è´ä»£ç </span>
</span></span><span class=line><span class=cl>â”œâ”€â”€ bin
</span></span><span class=line><span class=cl>â”œâ”€â”€ config <span class=c1># YAMl æ–‡ä»¶</span>
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ crd <span class=c1># è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCustom Resource Definitionï¼‰</span>
</span></span><span class=line><span class=cl>â”‚   â”‚       <span class=c1># ç”¨äºè‡ªå®šä¹‰èµ„æºæ³¨å†Œå’ŒæœåŠ¡å‘ç°</span>
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ manager <span class=c1># Operator Deployment éƒ¨ç½² YAML æ–‡ä»¶</span>
</span></span><span class=line><span class=cl>â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
</span></span><span class=line><span class=cl>â”‚   â”‚   â””â”€â”€ manager.yaml
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ rbac <span class=c1># RBAC æƒé™ç›¸å…³</span>
</span></span><span class=line><span class=cl>â”‚   â””â”€â”€ samples <span class=c1># CR å®ä¾‹</span>
</span></span><span class=line><span class=cl>â”œâ”€â”€ controllers
</span></span><span class=line><span class=cl>â”‚   â””â”€ rebootpolicy_controller.go <span class=c1># æ§åˆ¶å™¨ä»£ç ï¼Œå®ç°äº† k8s go-client</span>
</span></span><span class=line><span class=cl>â”‚                                 <span class=c1># è®¿é—® kube-apiserver</span>
</span></span><span class=line><span class=cl>â”œâ”€â”€ go.mod
</span></span><span class=line><span class=cl>â”œâ”€â”€ Dockerfile
</span></span><span class=line><span class=cl>â”œâ”€â”€ Makefile <span class=c1># Operator éƒ¨ç½²å®‰è£…å‘½ä»¤</span>
</span></span><span class=line><span class=cl>â””â”€â”€ main.go <span class=c1># Operator å…¥å£ç¨‹åº</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=æµ‹è¯•éƒ¨ç½²>æµ‹è¯•éƒ¨ç½²</h3><p>api/valpha1/rebootpolicy_types.go åŒ…å«äº†è‡ªå®šä¹‰èµ„æºçš„ Go ä»£ç ï¼Œä»£ç é‡Œé»˜è®¤å®šä¹‰äº†ä¸¤ä¸ªç»“æ„ä½“ <code>RebootPolicy</code> å’Œ <code>RebootPolicyList</code>ã€‚æµ‹è¯•éƒ¨ç½²ï¼Œé¦–å…ˆä½¿ç”¨ <code>make install</code> å‘½ä»¤å®‰è£…è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCustomResourceDefinitionï¼ŒCRDï¼‰æ–‡ä»¶åˆ° K8s é›†ç¾¤ï¼ˆé€šè¿‡è¯»å– ~/.kube/configï¼Œæœ¬åœ°æµ‹è¯• K8s ç¯å¢ƒå¯ä»¥ä½¿ç”¨ minikubeï¼‰ã€‚CRD æ˜¯å¯¹è‡ªå®šä¹‰èµ„æºçš„ç»“æ„åŒ–å®šä¹‰ï¼Œå®šä¹‰äº† CR æ”¯æŒçš„å­—æ®µã€å­—æ®µç±»å‹ã€‚ä½¿ç”¨ CR å‰å¿…é¡»å…ˆåˆ›å»ºå¹¶åº”ç”¨å¯¹åº”çš„ CRDã€‚å¦‚ä¸‹ç‰‡æ®µæ˜¯é»˜è®¤åˆ›å»ºå‡ºæ¥çš„ CRDï¼Œå®šä¹‰äº†è‡ªå®šä¹‰èµ„æº RebootPolicyï¼Œspec é‡ŒåŒ…å«ä¸€ä¸ª foo å­—æ®µã€‚</p><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># kubectl get crd rebootpolicies.autoreboot.my.domain -oyaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apiextensions.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CustomResourceDefinition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rebootpolicies.autoreboot.my.domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>autoreboot.my.domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>names</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RebootPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>listKind</span><span class=p>:</span><span class=w> </span><span class=l>RebootPolicyList</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>plural</span><span class=p>:</span><span class=w> </span><span class=l>rebootpolicies</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>singular</span><span class=p>:</span><span class=w> </span><span class=l>rebootpolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scope</span><span class=p>:</span><span class=w> </span><span class=l>Namespaced</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>versions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>schema</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>openAPIV3Schema</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>RebootPolicy is the Schema for the rebootpolicies API</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;APIVersion defines the versioned schema of this representation
</span></span></span><span class=line><span class=cl><span class=s1>              of an object. Servers should convert recognized schemas to the latest
</span></span></span><span class=line><span class=cl><span class=s1>              internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>kind</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;Kind is a string value representing the REST resource this
</span></span></span><span class=line><span class=cl><span class=s1>              object represents. Servers may infer this from the endpoint the client
</span></span></span><span class=line><span class=cl><span class=s1>              submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>RebootPolicySpec defines the desired state of RebootPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>foo</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>Foo is an example field of RebootPolicy. Edit rebootpolicy_types.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=l>to remove/update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>RebootPolicyStatus defines the observed state of RebootPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>subresources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æœ‰äº† RebootPolicy CRDï¼Œæˆ‘ä»¬å¯ä»¥åº”ç”¨ config/samples ä¸‹çš„ CRï¼š<code>kubectl apply -f config/samples/autoreboot_v1alpha1_rebootpolicy.yaml</code>ã€‚å¯ä»¥çœ‹åˆ°ä¸€ä¸ªåä¸º rebootpolicy-sample çš„ CR å·²æˆåŠŸåˆ›å»ºã€‚æˆ‘ä»¬å¯ä»¥åƒè®¿é—® K8s å†…ç½®èµ„æºä¸€æ ·ï¼Œæ“ä½œè¯¥è‡ªå®šä¹‰èµ„æºã€‚</p><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># é€šè¿‡ kubectl è®¿é—®</span>
</span></span><span class=line><span class=cl>$ kubectl get rebootpolicies rebootpolicy-sample
</span></span><span class=line><span class=cl>NAME                  AGE
</span></span><span class=line><span class=cl>rebootpolicy-sample   2m3s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># é€šè¿‡ K8s API è®¿é—®</span>
</span></span><span class=line><span class=cl>$ kubectl get --raw /apis/autoreboot.my.domain/v1alpha1/namespaces/default/rebootpolicies/rebootpolicy-sample
</span></span><span class=line><span class=cl>apiVersion: autoreboot.my.domain/v1alpha1
</span></span><span class=line><span class=cl>kind: RebootPolicy
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  annotations:
</span></span><span class=line><span class=cl>    kubectl.kubernetes.io/last-applied-configuration: <span class=p>|</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span><span class=s2>&#34;apiVersion&#34;</span>:<span class=s2>&#34;autoreboot.my.domain/v1alpha1&#34;</span>,<span class=s2>&#34;kind&#34;</span>:<span class=s2>&#34;RebootPolicy&#34;</span>,<span class=s2>&#34;metadata&#34;</span>:<span class=o>{</span><span class=s2>&#34;annotations&#34;</span>:<span class=o>{}</span>,<span class=s2>&#34;name&#34;</span>:<span class=s2>&#34;rebootpolicy-sample&#34;</span>,<span class=s2>&#34;namespace&#34;</span>:<span class=s2>&#34;default&#34;</span><span class=o>}</span>,<span class=s2>&#34;spec&#34;</span>:null<span class=o>}</span>
</span></span><span class=line><span class=cl>  creationTimestamp: <span class=s2>&#34;2022-01-17T03:09:17Z&#34;</span>
</span></span><span class=line><span class=cl>  generation: <span class=m>1</span>
</span></span><span class=line><span class=cl>  name: rebootpolicy-sample
</span></span><span class=line><span class=cl>  namespace: default
</span></span><span class=line><span class=cl>  resourceVersion: <span class=s2>&#34;214734&#34;</span>
</span></span><span class=line><span class=cl>  uid: 208c992e-f134-470d-8bc8-97191c3a6c4f
</span></span></code></pre></td></tr></table></div></div><p>Operator ä¹Ÿæ˜¯é€šè¿‡è®¿é—® kube-apiserver è·å– CR çš„çŠ¶æ€ã€‚æœ¬åœ°æµ‹è¯•è¿è¡Œ Operator å¯ä»¥ä½¿ç”¨ <code>make run</code> å‘½ä»¤ï¼ˆè™½ç„¶ç°åœ¨ Operator ä»£ç é‡Œæ²¡æœ‰ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼‰ã€‚</p><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/Users/xxx/GolandProjects/autorebooter/bin/controller-gen rbac:roleName<span class=o>=</span>manager-role crd webhook <span class=nv>paths</span><span class=o>=</span><span class=s2>&#34;./...&#34;</span> output:crd:artifacts:config<span class=o>=</span>config/crd/bases
</span></span><span class=line><span class=cl>/Users/xxx/GolandProjects/autorebooter/bin/controller-gen object:headerFile<span class=o>=</span><span class=s2>&#34;hack/boilerplate.go.txt&#34;</span> <span class=nv>paths</span><span class=o>=</span><span class=s2>&#34;./...&#34;</span>
</span></span><span class=line><span class=cl>go fmt ./...
</span></span><span class=line><span class=cl>go vet ./...
</span></span><span class=line><span class=cl>go run ./main.go
</span></span><span class=line><span class=cl>2022-01-17T11:24:56.834+0800    INFO    controller-runtime.metrics      metrics server is starting to listen    <span class=o>{</span><span class=s2>&#34;addr&#34;</span>: <span class=s2>&#34;:8080&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>2022-01-17T11:24:56.835+0800    INFO    setup   starting manager
</span></span><span class=line><span class=cl>2022-01-17T11:24:56.835+0800    INFO    starting metrics server <span class=o>{</span><span class=s2>&#34;path&#34;</span>: <span class=s2>&#34;/metrics&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>2022-01-17T11:24:56.835+0800    INFO    controller.rebootpolicy Starting EventSource    <span class=o>{</span><span class=s2>&#34;reconciler group&#34;</span>: <span class=s2>&#34;autoreboot.my.domain&#34;</span>, <span class=s2>&#34;reconciler kind&#34;</span>: <span class=s2>&#34;RebootPolicy&#34;</span>, <span class=s2>&#34;source&#34;</span>: <span class=s2>&#34;kind source: /, Kind=&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>2022-01-17T11:24:56.835+0800    INFO    controller.rebootpolicy Starting Controller     <span class=o>{</span><span class=s2>&#34;reconciler group&#34;</span>: <span class=s2>&#34;autoreboot.my.domain&#34;</span>, <span class=s2>&#34;reconciler kind&#34;</span>: <span class=s2>&#34;RebootPolicy&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>2022-01-17T11:24:56.937+0800    INFO    controller.rebootpolicy Starting workers        <span class=o>{</span><span class=s2>&#34;reconciler group&#34;</span>: <span class=s2>&#34;autoreboot.my.domain&#34;</span>, <span class=s2>&#34;reconciler kind&#34;</span>: <span class=s2>&#34;RebootPolicy&#34;</span>, <span class=s2>&#34;worker count&#34;</span>: 1<span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=å®šä¹‰è‡ªå®šä¹‰èµ„æº>å®šä¹‰è‡ªå®šä¹‰èµ„æº</h3><p>æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œæˆ‘ä»¬å®šä¹‰å¦‚ä¸‹ CRã€‚è‡ªå®šä¹‰èµ„æº RebootPolicy çš„ spec å­—æ®µç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼štarget å’Œ policies æ•°ç»„ã€‚target å¼•ç”¨ä¸€ä¸ªæœŸæœ›æ ¹æ®é‡å¯ç­–ç•¥è‡ªåŠ¨é‡å¯çš„åº”ç”¨ï¼Œpolicies å®šä¹‰ä¸€ç»„é‡å¯è§¦å‘ç­–ç•¥ã€‚æ¯ä¸€ä¸ªè§¦å‘å™¨æ˜¯ä¸€ä¸ªæ¢é’ˆï¼Œè®¾è®¡ä¸Šå‚è€ƒäº† Pod çš„å­˜æ´»æ¢é’ˆã€‚ç¤ºä¾‹ä¸­å®šä¹‰äº†ä¸€ä¸ªé‡å¯è§¦å‘ç­–ç•¥ policy-1ï¼Œå®ƒæ¯éš” 5 ç§’æ‰§è¡Œ Operator é‡Œ /policies ç›®å½•ä¸‹æŒ‚è½½çš„ diff.sh è„šæœ¬ï¼ˆè¿æ¥ã€è¯»å– MySQL è¡¨å­—æ®µå€¼å¹¶ä¸ä¸Šä¸€æ¬¡çš„å€¼æ¯”è¾ƒï¼‰ã€‚ä¸€æ—¦è„šæœ¬é€€å‡ºç ä¸ä¸º 0ï¼Œé‡å¯ target å¼•ç”¨çš„å·¥ä½œè´Ÿè½½ã€‚é‡å¯æ–¹å¼ç±»ä¼¼ä¸ kubectl rollout restart ä¿®æ”¹ .spec.template.metadata.annotations å­—æ®µ <code>kubectl.kubernetes.io/restartedAt: "2022-01-17T11:55:27+08:00"</code>ã€‚</p><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autorebooting.demo.netease.com/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RebootPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rebootpolicy-sample</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>policies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>policy-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>comment</span><span class=p>:</span><span class=w> </span><span class=l>xxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>trigger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>probe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;bash&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;./scripts/diff.sh&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å›åˆ° api/valpha1/rebootpolicy_types.go ä»£ç ï¼Œä¿®æ”¹ RebootPolicySpec ç»“æ„ä½“ï¼Œå¢åŠ  Target å’Œ Policies å­—æ®µï¼š</p><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=nx>corev1</span> <span class=s>&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// RebootPolicySpec defines the desired state of RebootPolicy
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>RebootPolicySpec</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>Target</span>   <span class=nx>Target</span>   <span class=s>`json:&#34;target,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Policies</span> <span class=p>[]</span><span class=nx>Policy</span> <span class=s>`json:&#34;policies,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Target</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span> <span class=s>`json:&#34;,inline&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>            <span class=kt>string</span> <span class=s>`json:&#34;name,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=c1>// - è¡¨ç¤ºè½¬ JSON æ—¶å¿½ç•¥è¯¥å­—æ®µã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// æœ¬ç¤ºä¾‹ä¸­ target éƒ½é»˜è®¤å­˜åœ¨äºä¸ CR åŒå‘½åç©ºé—´ä¸‹ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// å¢åŠ è¯¥å­—æ®µä»…ç”¨äºè¾…åŠ©ç¼–ç¨‹ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Namespace</span>       <span class=kt>string</span> <span class=s>`json:&#34;-&#34;`</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Policy</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>    <span class=kt>string</span>  <span class=s>`json:&#34;name,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Comment</span> <span class=kt>string</span>  <span class=s>`json:&#34;comment,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Trigger</span> <span class=nx>Trigger</span> <span class=s>`json:&#34;trigger,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Trigger</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Probe</span> <span class=o>*</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Probe</span> <span class=s>`json:&#34;probe,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é‡æ–° <code>make install</code> å®‰è£… CRDã€‚<code>make install</code> ä¼šè°ƒç”¨ <code>make manifests</code> å‘½ä»¤ç”Ÿæˆæ–°çš„æ·±æ‹·è´ä»£ç ä»¥åŠæ›´æ–°åçš„ CRD YAMLã€‚</p><h3 id=ç¼–å†™æ§åˆ¶å™¨>ç¼–å†™æ§åˆ¶å™¨</h3><p>æ§åˆ¶å™¨æœ¬èº«æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯è¿›ç¨‹ï¼Œä¸€æ—¦ç›‘å¬åˆ° CR çš„åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤å°±ä¼šè§¦å‘ controllers/rebootpolicy_controller.go æ§åˆ¶å™¨ä»£ç é‡Œçš„è°ƒåå‡½æ•° Reconcile()ã€‚æ‰€ä»¥ä¸šåŠ¡é€»è¾‘éƒ½åº”è¯¥æ”¾åœ¨ Reconcile é‡Œã€‚åç»­æ–‡ç« æˆ‘ä»¬ä¼šè¯¦ç»†ä»‹ç» Kubebuilder ç”Ÿæˆçš„å…¶ä»–æ¨¡æ¿ä»£ç çš„å«ä¹‰ä»¥åŠæ›´å¤šæœ€ä½³å®è·µã€‚æˆ‘ä»¬åœ¨ Reconcile é‡Œç¼–å†™ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=nx>prober</span> <span class=s>&#34;my.domain/autorebooter/pkg&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>RebootPolicyReconciler</span><span class=p>)</span> <span class=nf>Reconcile</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>log</span><span class=p>.</span><span class=nf>FromContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO(user): your logic here
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// CR äº‹ä»¶è§¦å‘ Reconcileã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ç¬¬ä¸€æ­¥ï¼Œå…ˆè·å– CR å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>rp</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>autorebooterv1alpha1</span><span class=p>.</span><span class=nx>RebootPolicy</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>,</span> <span class=nx>rp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ç¬¬äºŒæ­¥ï¼Œæ‹¿åˆ°è¦é‡å¯çš„ç›®æ ‡å·¥ä½œè´Ÿè½½
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// å¹¶é»˜è®¤è®¾ç½®è¯¥å·¥ä½œè´Ÿè½½åœ¨ä¸ CR åŒåçš„å‘½åç©ºé—´ä¸‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>t</span> <span class=o>:=</span> <span class=nx>rp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Target</span>
</span></span><span class=line><span class=cl>    <span class=nx>t</span><span class=p>.</span><span class=nx>Namespace</span> <span class=p>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Namespace</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ç¬¬ä¸‰æ­¥ï¼Œåˆå§‹åŒ–æ¢é’ˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// å®ç°ä¸Šå‚è€ƒäº† kubelet probe_manager æºç 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>prober</span><span class=p>.</span><span class=nf>Init</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=nx>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>p</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>rp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Policies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å¯åŠ¨åå° goroutineï¼Œå‘¨æœŸæ€§åœ°æ¢æµ‹ï¼Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// å¹¶æ ¹æ®ç­–ç•¥é‡å¯æ‰§è¡Œé‡å¯
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>prober</span><span class=p>.</span><span class=nf>AddProbe</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸€æ—¦è§¦å‘ Reconcile()ï¼Œä»£ç æ‰§è¡Œå››æ­¥æ“ä½œï¼šç¬¬ä¸€æ­¥ï¼Œæ‹¿åˆ°æœ€æ–°çš„ CRï¼Œåº•å±‚åŸç†ä¸Šå¹¶ä¸æ˜¯é€šè¿‡è®¿é—® kube-apiserver ä» etcd æ‹¿æ•°æ®ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œè¿™æ ·é¿å…é¢‘ç¹ä¸ kube-apiserver é€šä¿¡ï¼›ç¬¬äºŒæ­¥ï¼Œä» CR è·å–æˆ‘ä»¬è¦å®ç°è‡ªåŠ¨é‡å¯çš„ç›®æ ‡å·¥ä½œè´Ÿè½½ï¼›ç¬¬ä¸‰æ­¥ï¼Œåˆå§‹åŒ–æ¢é’ˆç®¡ç†ï¼Œå¹¶æ ¹æ®å®šä¹‰çš„é‡å¯æ¢é’ˆç­–ç•¥ï¼Œåˆ›å»ºåå°æ¢é’ˆ goroutine å‘¨æœŸæ€§åœ°æ‰§è¡Œæ¢é’ˆæ£€æµ‹ï¼Œå¹¶æŒ‰éœ€è¦é‡å¯ç›®æ ‡åº”ç”¨ï¼ˆæ‰“ annotation è¡¥ä¸ï¼‰ã€‚è¿™é‡Œå†™å›æ“ä½œæ˜¯è¯·æ±‚å‘å¾€ kube-apiserverã€‚</p><p>prober.Init å’Œ prober.AddProbe æ˜¯æˆ‘ä»¬å®šä¹‰çš„ä»£ç ï¼Œå‚è€ƒäº† kubelet probe_manager æºç ã€‚ä»£ç å¯ä»¥æ”¾åœ¨ /pkg ç›®å½•ä¸‹ probe_manager.go å’Œ worker.goã€‚åœ¨ probe_manager.go å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ probe managerï¼Œè°ƒç”¨ Init å‡½æ•°åˆå§‹åŒ–è¯¥ managerï¼›è°ƒç”¨ AddProbe åˆ™ä¼šå¯åŠ¨ä¸€ä¸ª worker åç¨‹ï¼Œå¹¶åŠ å…¥åˆ° workers æ•°ç»„ä¸­ã€‚</p><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// probe_manager.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>manager</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>client</span>  <span class=nx>client</span><span class=p>.</span><span class=nx>Client</span>
</span></span><span class=line><span class=cl>    <span class=nx>workers</span> <span class=p>[]</span><span class=nx>worker</span>
</span></span><span class=line><span class=cl>    <span class=nx>target</span>  <span class=nx>v1alpha1</span><span class=p>.</span><span class=nx>Target</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>once</span>            <span class=nx>sync</span><span class=p>.</span><span class=nx>Once</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalManager</span> <span class=o>*</span><span class=nx>manager</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Init</span><span class=p>(</span><span class=nx>c</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=nx>t</span> <span class=nx>v1alpha1</span><span class=p>.</span><span class=nx>Target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>once</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>internalManager</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>manager</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>client</span><span class=p>:</span>  <span class=nx>c</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>workers</span><span class=p>:</span> <span class=p>[]</span><span class=nx>worker</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>w</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>internalManager</span><span class=p>.</span><span class=nx>workers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>w</span><span class=p>.</span><span class=nf>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalManager</span><span class=p>.</span><span class=nx>workers</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>worker</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalManager</span><span class=p>.</span><span class=nx>target</span> <span class=p>=</span> <span class=nx>t</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>AddProbe</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>p</span> <span class=nx>v1alpha1</span><span class=p>.</span><span class=nx>Policy</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>w</span> <span class=o>:=</span> <span class=nf>newWorker</span><span class=p>(</span><span class=nx>internalManager</span><span class=p>.</span><span class=nx>client</span><span class=p>,</span> <span class=nx>internalManager</span><span class=p>.</span><span class=nx>target</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Trigger</span><span class=p>.</span><span class=nx>Probe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalManager</span><span class=p>.</span><span class=nx>workers</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>internalManager</span><span class=p>.</span><span class=nx>workers</span><span class=p>,</span> <span class=nx>w</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=nx>w</span><span class=p>.</span><span class=nf>run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>worker.go ä»£ç ç®¡ç† worker åå°åç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚run() ä¸­ä¼šå…ˆåš doProbe æ¢æµ‹ï¼Œæ¯”å¦‚æ‰§è¡Œ exec æ¢é’ˆè¿è¡Œ shell è„šæœ¬ã€‚å¦‚æœè¿”å›ç ä¸ä¸º 0ï¼Œåˆ™è®¤ä¸ºéœ€è¦é‡å¯å¹¶è°ƒç”¨ rolloutRestart()ã€‚rolloutRestart å…ˆç¡®å®šç›®æ ‡å·¥ä½œè´Ÿè½½çš„ API ç±»å‹ï¼ˆGVKï¼‰ï¼Œç„¶åæ‰§è¡Œ Patch æ“ä½œæ›´æ–°ã€‚</p><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// worker.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=nx>patchJSON</span> <span class=p>=</span> <span class=s>`{&#34;spec&#34;: {&#34;template&#34;: {&#34;metadata&#34;: {&#34;annotations&#34;: {&#34;autorebooter.my.domain/restartedAt&#34;: &#34;%s&#34;}}}}}`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>worker</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>client</span><span class=p>.</span><span class=nx>Client</span>
</span></span><span class=line><span class=cl>    <span class=nx>stopCh</span> <span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Describes the probe configuration (read-only)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>target</span> <span class=nx>v1alpha1</span><span class=p>.</span><span class=nx>Target</span>
</span></span><span class=line><span class=cl>    <span class=nx>spec</span>   <span class=o>*</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Probe</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newWorker</span><span class=p>(</span><span class=nx>c</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=nx>target</span> <span class=nx>v1alpha1</span><span class=p>.</span><span class=nx>Target</span><span class=p>,</span> <span class=nx>spec</span> <span class=o>*</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Probe</span><span class=p>)</span> <span class=nx>worker</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>stopChan</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>worker</span><span class=p>{</span><span class=nx>c</span><span class=p>,</span> <span class=nx>stopChan</span><span class=p>,</span> <span class=nx>target</span><span class=p>,</span> <span class=nx>spec</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>worker</span><span class=p>)</span> <span class=nf>run</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>l</span> <span class=o>:=</span> <span class=nx>log</span><span class=p>.</span><span class=nf>FromContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>probeTickerPeriod</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>w</span><span class=p>.</span><span class=nx>spec</span><span class=p>.</span><span class=nx>PeriodSeconds</span><span class=p>)</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span>
</span></span><span class=line><span class=cl>    <span class=nx>probeTicker</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTicker</span><span class=p>(</span><span class=nx>probeTickerPeriod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>probeLoop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>shouldReboot</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nf>doProbe</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>l</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;fail to probe&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>shouldReboot</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// reboot target
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>err</span> <span class=p>=</span> <span class=nx>w</span><span class=p>.</span><span class=nf>rolloutRestart</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>l</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;fail to rollout restart&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Wait for next probe tick.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span> <span class=nx>probeLoop</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>w</span><span class=p>.</span><span class=nx>stopCh</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span> <span class=nx>probeLoop</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>probeTicker</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1>// continue
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>worker</span><span class=p>)</span> <span class=nf>doProbe</span><span class=p>()</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>result</span> <span class=nx>probe</span><span class=p>.</span><span class=nx>Result</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>w</span><span class=p>.</span><span class=nx>spec</span><span class=p>.</span><span class=nx>Exec</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>w</span><span class=p>.</span><span class=nx>spec</span><span class=p>.</span><span class=nx>Exec</span><span class=p>.</span><span class=nx>Command</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>p</span> <span class=o>:=</span> <span class=nx>execprobe</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nx>cmd</span> <span class=o>:=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>New</span><span class=p>().</span><span class=nf>Command</span><span class=p>(</span><span class=nx>w</span><span class=p>.</span><span class=nx>spec</span><span class=p>.</span><span class=nx>Exec</span><span class=p>.</span><span class=nx>Command</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>w</span><span class=p>.</span><span class=nx>spec</span><span class=p>.</span><span class=nx>Exec</span><span class=p>.</span><span class=nx>Command</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>result</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>Probe</span><span class=p>(</span><span class=nx>cmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>result</span> <span class=o>==</span> <span class=nx>probe</span><span class=p>.</span><span class=nx>Failure</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>worker</span><span class=p>)</span> <span class=nf>stop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>w</span><span class=p>.</span><span class=nx>stopCh</span> <span class=o>&lt;-</span> <span class=kd>struct</span><span class=p>{}{}:</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=p>:</span> <span class=c1>// Non-blocking.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// inspired by kubectl rollout restart
</span></span></span><span class=line><span class=cl><span class=c1>// refer to https://github.com/kubernetes/kubectl/blob/release-1.16/pkg/polymorphichelpers/objectrestarter.go#L32
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>worker</span><span class=p>)</span> <span class=nf>rolloutRestart</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>targetGV</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>schema</span><span class=p>.</span><span class=nf>ParseGroupVersion</span><span class=p>(</span><span class=nx>w</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>APIVersion</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>gvk</span> <span class=o>:=</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionKind</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Group</span><span class=p>:</span>   <span class=nx>targetGV</span><span class=p>.</span><span class=nx>Group</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Version</span><span class=p>:</span> <span class=nx>targetGV</span><span class=p>.</span><span class=nx>Version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Kind</span><span class=p>:</span>    <span class=nx>w</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>Kind</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=nx>gvk</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionKind</span><span class=p>{</span><span class=nx>Group</span><span class=p>:</span> <span class=s>&#34;apps&#34;</span><span class=p>,</span> <span class=nx>Version</span><span class=p>:</span> <span class=s>&#34;v1&#34;</span><span class=p>,</span> <span class=nx>Kind</span><span class=p>:</span> <span class=s>&#34;Deployment&#34;</span><span class=p>}:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Patch
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>obj</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>appv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>Name</span><span class=p>:</span>      <span class=nx>w</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>Namespace</span><span class=p>:</span> <span class=nx>w</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>patchData</span> <span class=o>:=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>patchJSON</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>w</span><span class=p>.</span><span class=nf>Patch</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>obj</span><span class=p>,</span> <span class=nx>client</span><span class=p>.</span><span class=nf>RawPatch</span><span class=p>(</span><span class=nx>types</span><span class=p>.</span><span class=nx>StrategicMergePatchType</span><span class=p>,</span> <span class=nx>patchData</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionKind</span><span class=p>{</span><span class=nx>Group</span><span class=p>:</span> <span class=s>&#34;apps&#34;</span><span class=p>,</span> <span class=nx>Version</span><span class=p>:</span> <span class=s>&#34;v1&#34;</span><span class=p>,</span> <span class=nx>Kind</span><span class=p>:</span> <span class=s>&#34;StatefulSet&#34;</span><span class=p>}:</span> <span class=c1>// todo
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>case</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionKind</span><span class=p>{</span><span class=nx>Group</span><span class=p>:</span> <span class=s>&#34;apps&#34;</span><span class=p>,</span> <span class=nx>Version</span><span class=p>:</span> <span class=s>&#34;v1&#34;</span><span class=p>,</span> <span class=nx>Kind</span><span class=p>:</span> <span class=s>&#34;DaemonSet&#34;</span><span class=p>}:</span> <span class=c1>// todo
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è‡³æ­¤ï¼Œæˆ‘ä»¬ä»£ç é€»è¾‘å·²å®Œæˆï¼Œç°åœ¨å¯ä»¥åœ¨æœ¬åœ° K8s é›†ç¾¤ä¸Šæµ‹è¯•ï¼ˆå¦‚ï¼Œminikubeï¼‰ï¼š</p><ol>
<li><code>make install & kubectl apply -f config/samples/autoreboot_v1alpha1_rebootpolicy.yaml</code> å®‰è£… CRD å’Œ CRã€‚åœ¨æˆ‘ä»¬çš„ RebootPolicy ä¸­è®¾ç½®äº†è„šæœ¬è·¯å¾„ä¸º ./scripts/diff.shã€‚è¿™ä¸ªè„šæœ¬çš„å†…å®¹æ˜¯è¿æ¥æœ¬åœ° mysqlï¼Œè®¿é—®æ¯”è¾ƒ demo_tbl è¡¨çš„ name å­—æ®µã€‚</li></ol><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nv>HOST</span><span class=o>=</span>127.0.0.1
</span></span><span class=line><span class=cl><span class=nv>USER</span><span class=o>=</span>root
</span></span><span class=line><span class=cl><span class=nv>PASSWORD</span><span class=o>=</span>root
</span></span><span class=line><span class=cl><span class=nv>DATABASE_NAME</span><span class=o>=</span>demo
</span></span><span class=line><span class=cl><span class=nv>TABLE_NAME</span><span class=o>=</span>demo_tbl
</span></span><span class=line><span class=cl><span class=nv>OLDFILE</span><span class=o>=</span>oldout.tmp
</span></span><span class=line><span class=cl><span class=nv>NEWFILE</span><span class=o>=</span>newout.tmp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># install mysql</span>
</span></span><span class=line><span class=cl>which mysql
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> !<span class=o>=</span> <span class=m>0</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> <span class=nv>$IS_INSTALLING_MYSQL</span> <span class=o>==</span> <span class=m>1</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    apt-get install mysql-client -y
</span></span><span class=line><span class=cl>    <span class=nb>export</span> <span class=nv>IS_INSTALLING_MYSQL</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># connect to mysql</span>
</span></span><span class=line><span class=cl>mysql -h<span class=nv>$HOST</span> -u<span class=nv>$USER</span> -p<span class=nv>$PASSWORD</span> <span class=s>&lt;&lt; EOF &gt; $NEWFILE
</span></span></span><span class=line><span class=cl><span class=s>  USE $DATABASE_NAME;
</span></span></span><span class=line><span class=cl><span class=s>  SELECT name FROM $TABLE_NAME;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># compare</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -f <span class=nv>$OLDFILE</span> <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=k>then</span>
</span></span><span class=line><span class=cl>  diff <span class=nv>$NEWFILE</span> <span class=nv>$OLDFILE</span> &gt; /dev/null
</span></span><span class=line><span class=cl>  <span class=nv>RET</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>  <span class=c1># promote new output to old</span>
</span></span><span class=line><span class=cl>  mv <span class=nv>$NEWFILE</span> <span class=nv>$OLDFILE</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> <span class=nv>$RET</span> !<span class=o>=</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>  mv <span class=nv>$NEWFILE</span> <span class=nv>$OLDFILE</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></td></tr></table></div></div><ol start=2>
<li>å‡†å¤‡æœ¬åœ° MySQL ç¯å¢ƒï¼ˆç”¨æˆ·å/å¯†ç ï¼šrootï¼‰ï¼Œéƒ¨ç½²ç›®æ ‡åº”ç”¨ï¼ˆå’Œ rebootpolicy-sample.spec.target çš„æè¿°ä¸€è‡´ï¼‰ï¼š</li></ol><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=o>`</span><span class=n>demo_tbl</span><span class=o>`</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=w> </span><span class=nb>INT</span><span class=w> </span><span class=n>UNSIGNED</span><span class=w> </span><span class=n>AUTO_INCREMENT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>`</span><span class=n>name</span><span class=o>`</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=w> </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>demo_tbl</span><span class=w> </span><span class=p>(</span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s2>&#34;aaa&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>demo_tbl</span><span class=w> </span><span class=p>(</span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s2>&#34;bbb&#34;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create deployment nginx --image<span class=o>=</span>nginx:1.14.2 --replicas<span class=o>=</span><span class=m>3</span>  --port<span class=o>=</span><span class=m>80</span>
</span></span></code></pre></td></tr></table></div></div><ol start=3>
<li>
<p><code>make run</code> æœ¬åœ°è¿è¡Œ Operator</p></li><li>
<p>åœ¨ MySQL ä¸­ä¿®æ”¹ name åˆ—ï¼Œè§‚å¯Ÿ kubectl get po å¯ä»¥çœ‹åˆ° Pod å…¨éƒ¨é‡å¯ã€‚</p></li></ol><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>demo_tbl</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;ccc&#34;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get po
</span></span><span class=line><span class=cl>NAME                     READY   STATUS              RESTARTS   AGE
</span></span><span class=line><span class=cl>nginx-56bc45d9f7-5kps5   1/1     Running             <span class=m>0</span>          2s
</span></span><span class=line><span class=cl>nginx-56bc45d9f7-7f4zk   0/1     ContainerCreating   <span class=m>0</span>          0s
</span></span><span class=line><span class=cl>nginx-6795d6456-hqm4r    1/1     Running             <span class=m>0</span>          62s
</span></span><span class=line><span class=cl>nginx-6795d6456-p68wl    1/1     Running             <span class=m>0</span>          59s
</span></span><span class=line><span class=cl>nginx-6795d6456-rklrt    1/1     Terminating         <span class=m>0</span>          60s
</span></span></code></pre></td></tr></table></div></div><h3 id=éƒ¨ç½²ä¸-rbac>éƒ¨ç½²ä¸ RBAC</h3><p>æµ‹è¯•é€šè¿‡åï¼Œå¯ä»¥æ‰“åŒ… Operator å’Œ CRï¼ŒCRD åˆ°æ­£å¼ç¯å¢ƒã€‚Operator ä»¥ Deployment å½¢å¼éƒ¨ç½²ã€‚ä½†åœ¨éƒ¨ç½²åˆ° Operator åˆ°æ­£å¼ç¯å¢ƒå‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é¢å¤–éƒ¨ç½² RBAC èµ„æºï¼Œå¦åˆ™ï¼ŒæŸ¥çœ‹ Operator æ—¥å¿—ä¼šå‘ç° Operator æ²¡æœ‰æƒé™æ“ä½œ Deployment APIã€‚æˆ‘ä»¬åœ¨æœ¬åœ°æµ‹è¯•ç¯å¢ƒå¯ä»¥æ­£å¸¸è¿è¡Œï¼Œæ˜¯å› ä¸ºä½¿ç”¨äº†é›†ç¾¤ç®¡ç†å‘˜ kubeconfigï¼Œæ‹¥æœ‰å¯¹æ‰€æœ‰ K8s API çš„è®¿é—®æƒé™ã€‚</p><p>Kubernetes ä½¿ç”¨åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆrole-based access controlï¼ŒRBACï¼‰è¿›è¡Œé‰´æƒ<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>ã€‚æˆ‘ä»¬çš„ Operator ä½¿ç”¨äº†ä¸‰ç§ RBAC èµ„æºï¼šClusterRoleï¼ŒClusterRoleBinding å’Œ ServiceAccountã€‚ä¸‰ä¸ª YAML æ–‡ä»¶åœ¨ /config/rbac ç›®å½•ä¸‹ã€‚ClusterRole å®šä¹‰äº†å…è®¸è®¿é—®çš„èµ„æºï¼ˆå¦‚ apps.deploymentï¼‰ä»¥åŠå…è®¸çš„æ“ä½œï¼ˆpatchï¼‰ã€‚ServiceAccount æ˜¯æŒ‚è½½åˆ°Pod é‡Œçš„æœåŠ¡è´¦æˆ·ï¼ˆé€šè¿‡ Pod YAML é‡Œ serviceAccountName å­—æ®µï¼‰ã€‚åœ¨æ²¡æœ‰æŒ‡å®š kubeconfig æ–‡ä»¶è·¯å¾„çš„æƒ…å†µï¼ŒOperator é»˜è®¤ä½¿ç”¨æœåŠ¡è´¦æˆ·é‡Œçš„ tokenï¼ˆå®¹å™¨å†…è·¯å¾„ï¼š/var/run/secrets/kubernetes.io/serviceaccount/tokenï¼‰è®¿é—® kube-apiserverã€‚ClusterRoleBinding ç»™ ServiceAccount ç»‘å®šä¸€ä¸ª ClusterRoleã€‚</p><blockquote>
<p>Role å’Œ ClusterRole çš„åŒºåˆ«åœ¨äºä½œç”¨èŒƒå›´ï¼ˆscopeï¼‰ï¼Œå‰è€…æ˜¯æ“ä½œæŒ‡å®šå‘½åç©ºé—´ä¸‹èµ„æºçš„è§’è‰²ï¼Œåè€…ä½œç”¨äºæ•´ä¸ªé›†ç¾¤æ‰€æœ‰å‘½åç©ºé—´ã€‚</p></blockquote><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>manager-role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>apps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>deployments</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>patch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>autoreboot.my.domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>rebootpolicies</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>manager-rolebinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>manager-role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>controller-manager</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™äº› RBAC èµ„æºä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºã€‚Kubebuilder æ¡†æ¶æ”¯æŒè‡ªåŠ¨ç”Ÿæˆæ­£ç¡®çš„ RBAC èµ„æº YAMLï¼Œåªéœ€è¦åœ¨ rebootpolicy_controller.go ä»£ç é‡ŒåŠ ä¸Šä»¥ä¸‹ tag å³å¯ï¼Œé€šè¿‡ <code>make manifests</code> å‘½ä»¤åˆ›å»ºç›¸å…³ YAMLã€‚</p><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>//+kubebuilder:rbac:groups=autoreboot.my.domain,resources=rebootpolicies,verbs=get;list;watch
</span></span></span><span class=line><span class=cl><span class=c1>//+kubebuilder:rbac:groups=apps,resources=deployments,verbs=patch
</span></span></span></code></pre></td></tr></table></div></div><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²å…¨éƒ¨ä»‹ç»å®Œ Operator æ¦‚å¿µã€Kubebuilder æ¡†æ¶ä»¥åŠå¦‚ä½•å®ç°ä¸€ä¸ª Operatorã€‚åç»­ä¼šä»‹ç» Kubebuilder æ¶æ„ã€æºç é˜…è¯»ä»¥åŠ Operator å¼€å‘æœ€ä½³å®è·µã€‚</p><section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p><a href=https://www.qikqiak.com/k8s-book/docs/32.DaemonSet%20%E4%B8%8E%20StatefulSet.html>ä» Docker åˆ° Kubernetes è¿›é˜¶: DaemonSet ä¸ StatefulSet çš„ä½¿ç”¨</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote>
<p><a href=https://www.baeldung.com/ops/kubernetes-deployment-vs-statefulsets>Kubernetes Deployment vs. StatefulSets</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote>
<p><a href=https://book.douban.com/subject/33393681/>Programming Kubernetes: Developing Cloud-Native Applications</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote>
<p><a href=https://book.kubebuilder.io/>The Kubebuilder Book</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5 role=doc-endnote>
<p><a href=https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/>Kubernetes æ–‡æ¡£ï¼šä½¿ç”¨ RBAC é‰´æƒ</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></article></main><script>const repo="mivinci/hugo-theme-minima",issueTerm="pathname",theme=localStorage.theme?`github-${localStorage.theme}`:"preferred-color-scheme",script=document.createElement("script");script.src="https://utteranc.es/client.js",script.async=!0,script.crossOrigin="anonymous",script.setAttribute("repo",repo),script.setAttribute("issue-term",issueTerm),script.setAttribute("theme",theme),script.setAttribute("label","comment"),document.querySelector("main").appendChild(script)</script>
<footer class="mt-8 flex sm:flex-col-reverse justify-between items-center">
<p class="mt-0 text-sm">
Â© huanggze 2021 |
<a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> on
<a href=https://github.com/mivinci/hugo-theme-minima target=_blank rel="noopener noreferrer">Minima</a>
</p><p class="flex items-center mt-0">
<a class="icon mx-2" href=https://github.com/huanggze title=github><svg fill="#63636f" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
</a>
<a class="icon mx-2" href=/index.xml title=rss><svg fill="#63636f" t="1626591563876" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="1984" width="18" height="16"><path d="M128 768a128 128 0 100 256 128 128 0 000-256zM0 368v176c265.104.0 480 214.912 480 480h176c0-362.32-293.696-656-656-656zM0 0v176c468.336.0 848 379.664 848 848h176C1024 458.464 565.536.0.0.0z" p-id="1985"/></svg>
</a>
</p></footer></body></html>