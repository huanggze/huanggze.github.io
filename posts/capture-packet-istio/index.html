<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Istio å®¢æˆ·ç«¯æº IP ä¿æŒ"><meta property="og:description" content="é—®é¢˜èƒŒæ™¯ å‘ç°é»˜è®¤éƒ¨ç½²çš„ Istio æœåŠ¡ç½‘æ ¼ä¸‹ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚ IP æºåœ°å€æ˜¯ 127.0.0.6ï¼Œè€Œä¸æ˜¯è¯·æ±‚æ–¹çš„çœŸå® IP åœ°å€ã€‚
ç¯å¢ƒå¤ç° ç¯å¢ƒå¤ç°æ€»å…±éœ€è¦å‡†å¤‡çš„å†…å®¹æ¸…å•ï¼š
æœåŠ¡ç«¯ Podï¼šæ‰“å°å®¢æˆ·ç«¯ IP åœ°å€ï¼› å®¢æˆ·ç«¯ Podï¼šå‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼› K8s ç¯å¢ƒï¼šä½¿ç”¨é˜¿é‡Œäº‘ ACK éƒ¨ç½² K8s ç¯å¢ƒï¼› Istioï¼šå®‰è£… Istioã€‚ å„éƒ¨ç½²ç›¸å…³çš„æ³¨æ„äº‹é¡¹è§ä¸‹é¢åˆ†å°èŠ‚çš„å†…å®¹ã€‚
1. æœåŠ¡ç«¯ demo åœ¨ 18080 ç«¯å£æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè§£æIPåœ°å€çš„æ–¹å¼è®¾ç½®ä¸ºä¸¤ç§ï¼šè¯»å– XFF é¦–éƒ¨ï¼Œæˆ– request çš„ RemoteAddr å­—æ®µã€‚
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main import ( &#34;fmt&#34; &#34;net/http&#34; ) func handle(w http.ResponseWriter, r *http."><meta property="og:type" content="article"><meta property="og:url" content="https://huanggze.top/posts/capture-packet-istio/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-14T21:56:37+08:00"><meta property="article:modified_time" content="2022-12-14T21:56:37+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Istio å®¢æˆ·ç«¯æº IP ä¿æŒ"><meta name=twitter:description content="é—®é¢˜èƒŒæ™¯ å‘ç°é»˜è®¤éƒ¨ç½²çš„ Istio æœåŠ¡ç½‘æ ¼ä¸‹ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚ IP æºåœ°å€æ˜¯ 127.0.0.6ï¼Œè€Œä¸æ˜¯è¯·æ±‚æ–¹çš„çœŸå® IP åœ°å€ã€‚
ç¯å¢ƒå¤ç° ç¯å¢ƒå¤ç°æ€»å…±éœ€è¦å‡†å¤‡çš„å†…å®¹æ¸…å•ï¼š
æœåŠ¡ç«¯ Podï¼šæ‰“å°å®¢æˆ·ç«¯ IP åœ°å€ï¼› å®¢æˆ·ç«¯ Podï¼šå‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼› K8s ç¯å¢ƒï¼šä½¿ç”¨é˜¿é‡Œäº‘ ACK éƒ¨ç½² K8s ç¯å¢ƒï¼› Istioï¼šå®‰è£… Istioã€‚ å„éƒ¨ç½²ç›¸å…³çš„æ³¨æ„äº‹é¡¹è§ä¸‹é¢åˆ†å°èŠ‚çš„å†…å®¹ã€‚
1. æœåŠ¡ç«¯ demo åœ¨ 18080 ç«¯å£æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè§£æIPåœ°å€çš„æ–¹å¼è®¾ç½®ä¸ºä¸¤ç§ï¼šè¯»å– XFF é¦–éƒ¨ï¼Œæˆ– request çš„ RemoteAddr å­—æ®µã€‚
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main import ( &#34;fmt&#34; &#34;net/http&#34; ) func handle(w http.ResponseWriter, r *http."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#262d33"><title>Hi Folks - Istio å®¢æˆ·ç«¯æº IP ä¿æŒ</title><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel=stylesheet><link rel=stylesheet href=/minima.1673755013.css><script defer type=text/javascript src=/minima.1673755013.js></script></head><script>try{"theme"in localStorage||(localStorage.theme=window.matchMedia("(prefer-color-scheme: dark)").matches?"dark":"light"),document.querySelector("html").classList.add(localStorage.theme)}catch(e){console.error(e)}</script><body class="sm:mx-5 sm:my-0"><header class="flex justify-between items-center mb-6 sm:my-3"><div class="flex items-center"><div id=theme-switcher class="text-4xl cursor-pointer">ğŸŒ</div></div><nav class="flex items-center
whitespace-nowrap overflow-x-auto overflow-y-hidden"><a class=ml-5 href=/>Home</a>
<a class=ml-5 href=/categories>Categories</a>
<a class=ml-5 href=/series>Series</a>
<a class=ml-5 href=/about>About</a></nav></header><details class="toc toc-lines"><summary></summary><div class=pb-1><nav id=TableOfContents><ul><li><a href=#é—®é¢˜èƒŒæ™¯>é—®é¢˜èƒŒæ™¯</a></li><li><a href=#ç¯å¢ƒå¤ç°>ç¯å¢ƒå¤ç°</a><ul><li><a href=#1-æœåŠ¡ç«¯-demo>1. æœåŠ¡ç«¯ demo</a></li><li><a href=#2-å®¢æˆ·ç«¯-demo>2. å®¢æˆ·ç«¯ demo</a></li><li><a href=#3-å‡†å¤‡-k8s-ç¯å¢ƒ>3. å‡†å¤‡ K8s ç¯å¢ƒ</a></li><li><a href=#4-å®‰è£…-istio>4. å®‰è£… Istio</a></li><li><a href=#5-å¤ç°>5. å¤ç°</a></li></ul></li><li><a href=#æ’æŸ¥æ­¥éª¤>æ’æŸ¥æ­¥éª¤</a><ul><li><a href=#1-æŸ¥çœ‹-istio-proxy-æ—¥å¿—>1. æŸ¥çœ‹ istio-proxy æ—¥å¿—</a></li><li><a href=#2-æŸ¥çœ‹-iptables-è§„åˆ™>2. æŸ¥çœ‹ iptables è§„åˆ™</a></li><li><a href=#3-istio-config-æŸ¥çœ‹-envoy-é…ç½®>3. istio-config æŸ¥çœ‹ Envoy é…ç½®</a></li></ul></li><li><a href=#è§£å†³åŠæ³•>è§£å†³åŠæ³•</a></li><li><a href=#å‚è€ƒèµ„æ–™>å‚è€ƒèµ„æ–™</a></li></ul></nav></div></details><h1 class="mt-6 mb-6">Istio å®¢æˆ·ç«¯æº IP ä¿æŒ</h1><div class="mb-3 text-xs flex justify-between sm:flex-col"><div>Posted at &mdash; Dec 14, 2022</div></div><main><p></p><article class=md><h2 id=é—®é¢˜èƒŒæ™¯>é—®é¢˜èƒŒæ™¯</h2><p>å‘ç°é»˜è®¤éƒ¨ç½²çš„ Istio æœåŠ¡ç½‘æ ¼ä¸‹ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚ IP æºåœ°å€æ˜¯ 127.0.0.6ï¼Œè€Œä¸æ˜¯è¯·æ±‚æ–¹çš„çœŸå® IP åœ°å€ã€‚</p><h2 id=ç¯å¢ƒå¤ç°>ç¯å¢ƒå¤ç°</h2><p>ç¯å¢ƒå¤ç°æ€»å…±éœ€è¦å‡†å¤‡çš„å†…å®¹æ¸…å•ï¼š</p><ul><li>æœåŠ¡ç«¯ Podï¼šæ‰“å°å®¢æˆ·ç«¯ IP åœ°å€ï¼›</li><li>å®¢æˆ·ç«¯ Podï¼šå‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼›</li><li>K8s ç¯å¢ƒï¼šä½¿ç”¨é˜¿é‡Œäº‘ ACK éƒ¨ç½² K8s ç¯å¢ƒï¼›</li><li>Istioï¼šå®‰è£… Istioã€‚</li></ul><p>å„éƒ¨ç½²ç›¸å…³çš„æ³¨æ„äº‹é¡¹è§ä¸‹é¢åˆ†å°èŠ‚çš„å†…å®¹ã€‚</p><h3 id=1-æœåŠ¡ç«¯-demo>1. æœåŠ¡ç«¯ demo</h3><p>åœ¨ 18080 ç«¯å£æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè§£æIPåœ°å€çš„æ–¹å¼è®¾ç½®ä¸ºä¸¤ç§ï¼šè¯»å– XFF é¦–éƒ¨ï¼Œæˆ– request çš„ RemoteAddr å­—æ®µã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>handle</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// æ‰“å°å®¢æˆ·ç«¯IP
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;X-Forwarded-For=%s, RemoteAddr=%s\n&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;X-Forwarded-For&#34;</span><span class=p>),</span> <span class=nx>r</span><span class=p>.</span><span class=nx>RemoteAddr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nf>Write</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=s>`{&#34;code&#34;: 0, &#34;status&#34;: &#34;fail&#34;, &#34;user&#34;: {&#34;id&#34;: &#34;test_common&#34;}}`</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/common/sauth&#34;</span><span class=p>,</span> <span class=nx>handle</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:18080&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é•œåƒæ„å»º Dockerfile å’Œå‘½ä»¤ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>docker buildx build --platform<span class=o>=</span>linux/amd64 -t vasth/simple-server .
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> golang:alpine</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> mkdir /app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . /app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> go build -o main .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;/app/main&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>K8s éƒ¨ç½² YAMLï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># server.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>simple-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo-to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>web</span><span class=p>:</span><span class=w> </span><span class=l>server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>web</span><span class=p>:</span><span class=w> </span><span class=l>server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>vasth/simple-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>simple-server-svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo-to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>web</span><span class=p>:</span><span class=w> </span><span class=l>server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>18080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>18080</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-å®¢æˆ·ç«¯-demo>2. å®¢æˆ·ç«¯ demo</h3><p>å‘æœåŠ¡ç«¯å‘é€ GET è¯·æ±‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>   <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>   <span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl>   <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>   <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;http://simple-server-svc.demo-to:18080/common/sauth&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Get err: %v\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=k>continue</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>raw</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;ReadAll err: %v\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=k>continue</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>raw</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Dockerfileå’ŒæœåŠ¡ç«¯ä¸€æ ·ï¼ŒK8s éƒ¨ç½² YAML å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># client.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>simple-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo-from</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>web</span><span class=p>:</span><span class=w> </span><span class=l>client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>web</span><span class=p>:</span><span class=w> </span><span class=l>client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>vasth/simple-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=3-å‡†å¤‡-k8s-ç¯å¢ƒ>3. å‡†å¤‡ K8s ç¯å¢ƒ</h3><p>åœ¨é˜¿é‡Œäº‘ ACK å®¹å™¨æœåŠ¡ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªé›†ç¾¤ã€‚æ³¨æ„ï¼Œé€‰æ‹©çš„èŠ‚ç‚¹æ“ä½œç³»ç»Ÿè¦æ˜¯ Alibaba Cloud Linux 2ï¼Œä¸èƒ½ç”¨ CentOSï¼Œæœ‰å†…æ ¸é—®é¢˜ã€‚ æˆ‘çš„æµ‹è¯•ç¯å¢ƒæ˜¯éƒ¨ç½²äº†ä¸¤ä¸ªå·¥ä½œèŠ‚ç‚¹ã€‚</p><h3 id=4-å®‰è£…-istio>4. å®‰è£… Istio</h3><p>Istio 1.11.3 ç‰ˆæœ¬æ–‡æ¡£ï¼š<a href=https://istio.io/v1.11/docs/setup/getting-started>https://istio.io/v1.11/docs/setup/getting-started</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># ä¸‹è½½ 1.11.3 ç‰ˆæœ¬çš„ istio</span>
</span></span><span class=line><span class=cl>curl -O https://ghproxy.com/https://github.com/istio/istio/releases/download/1.11.3/istioctl-1.11.3-linux-amd64.tar.gz
</span></span><span class=line><span class=cl>tar zxvf istioctl-1.11.3-linux-amd64.tar.gz
</span></span><span class=line><span class=cl>mv istioctl /usr/local/bin/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å®‰è£… istio</span>
</span></span><span class=line><span class=cl>istioctl install --set <span class=nv>profile</span><span class=o>=</span>demo -y
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å‡†å¤‡ namespace</span>
</span></span><span class=line><span class=cl>kubectl create ns demo-from
</span></span><span class=line><span class=cl>kubectl create ns demo-to
</span></span><span class=line><span class=cl>kubectl label namespace demo-from istio-injection<span class=o>=</span>enabled
</span></span><span class=line><span class=cl>kubectl label namespace demo-to istio-injection<span class=o>=</span>enabled
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># éƒ¨ç½²å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯Pod</span>
</span></span><span class=line><span class=cl>kubectl apply -f server.yaml
</span></span><span class=line><span class=cl>kubectl apply -f client.yaml
</span></span></code></pre></td></tr></table></div></div><h3 id=5-å¤ç°>5. å¤ç°</h3><p>ç°åœ¨ï¼Œå¯ä»¥æ‰“å°æœåŠ¡ç«¯æ—¥å¿—ï¼Œçœ‹åˆ°æ‰“å°çš„å®¢æˆ·ç«¯IPæ˜¯127.0.0.6ã€‚æœ¬æ–‡å°±æ˜¯ä»‹ç»ï¼š</p><p>1.ä¸ºä»€ä¹ˆä¸æ˜¯æ‰“å°å®¢æˆ·ç«¯çš„ Pod IPï¼Ÿ
2. å¦‚ä½•ä¿®å¤ï¼Ÿ
3. ä¸ºä»€ä¹ˆæ˜¯ 127.0.0.6ï¼Œè€Œä¸æ˜¯å…¶ä»–åœ°å€ï¼Ÿ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl logs -n demo-to -l <span class=nv>web</span><span class=o>=</span>server
</span></span><span class=line><span class=cl>X-Forwarded-For<span class=o>=</span>, <span class=nv>RemoteAddr</span><span class=o>=</span>127.0.0.6:44213
</span></span><span class=line><span class=cl>X-Forwarded-For<span class=o>=</span>, <span class=nv>RemoteAddr</span><span class=o>=</span>127.0.0.6:44213
</span></span><span class=line><span class=cl>X-Forwarded-For<span class=o>=</span>, <span class=nv>RemoteAddr</span><span class=o>=</span>127.0.0.6:44213
</span></span><span class=line><span class=cl>X-Forwarded-For<span class=o>=</span>, <span class=nv>RemoteAddr</span><span class=o>=</span>127.0.0.6:44213
</span></span><span class=line><span class=cl>X-Forwarded-For<span class=o>=</span>, <span class=nv>RemoteAddr</span><span class=o>=</span>127.0.0.6:44213
</span></span><span class=line><span class=cl>X-Forwarded-For<span class=o>=</span>, <span class=nv>RemoteAddr</span><span class=o>=</span>127.0.0.6:44213
</span></span></code></pre></td></tr></table></div></div><p>è€Œå®¢æˆ·ç«¯çš„å®é™…IPåœ°å€æ˜¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get po -n demo-from -owide
</span></span><span class=line><span class=cl>NAME                             READY   STATUS    RESTARTS   AGE     IP           NODE
</span></span><span class=line><span class=cl>simple-client-54f4f5cccb-mzjkw   2/2     Running   <span class=m>0</span>          7m32s   10.20.0.78   cn-xxx.192.168.0.127
</span></span></code></pre></td></tr></table></div></div><p>æœåŠ¡ç«¯ Pod IP å’Œ Service IP åˆ†åˆ«æ˜¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get po -n demo-to -owide
</span></span><span class=line><span class=cl>NAME                             READY   STATUS    RESTARTS   AGE     IP           NODE
</span></span><span class=line><span class=cl>simple-server-86b499d4dd-zd4pl   2/2     Running   <span class=m>0</span>          4h37m   10.20.0.77   cn-xxx.192.168.0.127
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl get svc -n demo-to
</span></span><span class=line><span class=cl>NAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>     AGE
</span></span><span class=line><span class=cl>simple-server-svc   ClusterIP   172.16.234.188   &lt;none&gt;        18080/TCP   5h44m
</span></span></code></pre></td></tr></table></div></div><h2 id=æ’æŸ¥æ­¥éª¤>æ’æŸ¥æ­¥éª¤</h2><p>æˆ‘ä»¬åˆ†åˆ«åšä»¥ä¸‹æ’æŸ¥æ­¥éª¤ï¼š</p><ol><li>æŸ¥çœ‹æœåŠ¡ç«¯ Pod çš„ istio-proxy å®¹å™¨æ—¥å¿—ï¼Œç¡®å®šå®¹å™¨çœ‹åˆ° 127.0.0.6 æ˜¯æ¥è‡ªå“ªä¸ªèŠ‚ç‚¹ï¼›</li><li>æŸ¥çœ‹æœåŠ¡ç«¯ Pod çš„ iptables è§„åˆ™ï¼Œç¡®å®š Pod æµé‡è½¬å‘è§„åˆ™ï¼›</li><li>æŸ¥çœ‹æœåŠ¡ç«¯ Pod çš„ Envoy é…ç½®è§„åˆ™ï¼Œç¡®å®šå®¢æˆ·ç«¯ IP è¢«ç¯¡æ”¹çš„åŸå› å’Œå®ç°è§„åˆ™ã€‚</li></ol><h3 id=1-æŸ¥çœ‹-istio-proxy-æ—¥å¿—>1. æŸ¥çœ‹ istio-proxy æ—¥å¿—</h3><p>istio-proxy æ—¥å¿—å®é™…æ˜¯ Envoy è®¿é—®æ—¥å¿—<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>ï¼Œæ‰“å° Envoy è®¿é—®æ—¥å¿—å¯ä»¥è¯¦ç»†çœ‹åˆ° Envoy å¦‚ä½•åšä»£ç†è½¬å‘çš„ã€‚å¦‚ä¸‹æ‰“å°æœåŠ¡ç«¯çš„ Envoy æ—¥å¿—ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl logs -n demo-to -l <span class=nv>web</span><span class=o>=</span>server -c istio-proxy
</span></span><span class=line><span class=cl><span class=o>[</span>2022-12-17T09:30:39.883Z<span class=o>]</span> <span class=s2>&#34;GET /common/sauth HTTP/1.1&#34;</span> <span class=m>200</span> - via_upstream - <span class=s2>&#34;-&#34;</span> <span class=m>0</span> <span class=m>60</span> <span class=m>0</span> <span class=m>0</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Go-http-client/1.1&#34;</span> <span class=s2>&#34;57dd8171-f8e0-9ffc-bfc4-cdf4d9f5ee0f&#34;</span> <span class=s2>&#34;simple-server-svc.demo-to:18080&#34;</span> <span class=s2>&#34;10.20.0.77:18080&#34;</span> inbound<span class=p>|</span>18080<span class=o>||</span> 127.0.0.6:44213 10.20.0.77:18080 10.20.0.78:33204 outbound_.18080_._.simple-server-svc.demo-to.svc.cluster.local default
</span></span><span class=line><span class=cl><span class=o>[</span>2022-12-17T09:30:40.885Z<span class=o>]</span> <span class=s2>&#34;GET /common/sauth HTTP/1.1&#34;</span> <span class=m>200</span> - via_upstream - <span class=s2>&#34;-&#34;</span> <span class=m>0</span> <span class=m>60</span> <span class=m>0</span> <span class=m>0</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Go-http-client/1.1&#34;</span> <span class=s2>&#34;84c216fd-6fe1-9986-b7ce-e259cdf61325&#34;</span> <span class=s2>&#34;simple-server-svc.demo-to:18080&#34;</span> <span class=s2>&#34;10.20.0.77:18080&#34;</span> inbound<span class=p>|</span>18080<span class=o>||</span> 127.0.0.6:44213 10.20.0.77:18080 10.20.0.78:33204 outbound_.18080_._.simple-server-svc.demo-to.svc.cluster.local default
</span></span><span class=line><span class=cl><span class=o>[</span>2022-12-17T09:30:41.888Z<span class=o>]</span> <span class=s2>&#34;GET /common/sauth HTTP/1.1&#34;</span> <span class=m>200</span> - via_upstream - <span class=s2>&#34;-&#34;</span> <span class=m>0</span> <span class=m>60</span> <span class=m>0</span> <span class=m>0</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Go-http-client/1.1&#34;</span> <span class=s2>&#34;a67101af-e469-91ab-99b0-61bb5abfa108&#34;</span> <span class=s2>&#34;simple-server-svc.demo-to:18080&#34;</span> <span class=s2>&#34;10.20.0.77:18080&#34;</span> inbound<span class=p>|</span>18080<span class=o>||</span> 127.0.0.6:44213 10.20.0.77:18080 10.20.0.78:33204 outbound_.18080_._.simple-server-svc.demo-to.svc.cluster.local default
</span></span></code></pre></td></tr></table></div></div><p>å„å­—æ®µè§£æå¯å‚è€ƒ Envoy æ–‡æ¡£<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>ï¼Œä»¥åŠå…¶ä»–åšå®¢<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>ã€‚åœ¨ Envoy accesslog æ—¥å¿—ä¸­ï¼Œå¦‚æœå­—æ®µå®é™…å€¼æ˜¯ç©ºï¼Œåˆ™ç”¨ &ldquo;-&rdquo; å­—ç¬¦ä¸²è¡¨ç¤ºã€‚</p><p>ç‰¹å®šæ—¥å¿—å­—æ®µæ ¼å¼çš„è¯´æ˜ï¼š</p><p><code>%RESPONSE_CODE_DETAILS%</code>ï¼šå“åº”ä½“çŠ¶æ€ç è¯¦ç»†è¯´æ˜<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>ã€‚</p><blockquote><ul><li>via_upstreamï¼šThe response code was set by the upstream.</li><li>upstream_response_timeout: The upstream response timed out.</li><li>duration_timeout: The max connection duration was exceeded.</li></ul></blockquote><p><code>%REQ(X?Y):Z%</code>ï¼šå¦‚ <code>%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%</code>ï¼Œæ‹¿å“åº”æŠ¥æ–‡é¦–éƒ¨ X-ENVOY-UPSTREAM-SERVICE-TIME çš„å€¼ã€‚</p><blockquote><p>HTTP:</p><ul><li>ä» HTTP Header ä¸­æ‹¿åˆ° X é¦–éƒ¨çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ‹¿é¦–éƒ¨ Yã€‚Z ä»£è¡¨æˆªå–çš„å­—ç¬¦é•¿åº¦ã€‚å¦‚æœé¦–éƒ¨éƒ½ä¸å­˜åœ¨ï¼Œåˆ™æ‰“å°"-"ã€‚</li></ul><p>TCP/UDP:</p><ul><li>æœªå®ç°é»˜è®¤"-"ã€‚</li></ul></blockquote><p><code>%UPSTREAM_CLUSTER%</code>ï¼šä¸Šæ¸¸æœåŠ¡çš„åœ°å€ï¼Œæ ¼å¼å¦‚ä¸‹<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>ï¼š</p><blockquote><p>å…¥æµé‡ï¼šinbound|portNumber|portName|Hostname
å‡ºæµé‡ï¼šinbound|portNumber|portName|Hostname</p><p>ç¤ºä¾‹ï¼š</p><ol><li>inbound|9080|http|productpage.istio-bookinfo-1-68819.svc.cluster.local</li><li>outbound|8000||httpbin.foo.svc.cluster.local</li></ol></blockquote><p>æ ¼å¼åŒ–å¤„ç†ä¹‹åçš„æ—¥å¿—ç¤ºä¾‹å¦‚ä¸‹ï¼Œä»¥æœåŠ¡ç«¯Podçš„ä»£ç†å®¹å™¨æ—¥å¿—ä¸ºä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;start_time&#34;</span>: <span class=s2>&#34;2022-12-17T09:30:41.888Z&#34;</span>, // è¯·æ±‚å¼€å§‹æ—¶é—´
</span></span><span class=line><span class=cl>  <span class=s2>&#34;method&#34;</span>: <span class=s2>&#34;GET&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;path&#34;</span>: <span class=s2>&#34;/common/sauth&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;protocol&#34;</span>: <span class=s2>&#34;HTTP/1.1&#34;</span>, // ä¸Šæ¸¸æœåŠ¡çš„åè®®ï¼Œå¦‚æœæ˜¯ HTTP åˆ™å¯é€‰å€¼åˆ†HTTPç‰ˆæœ¬ï¼›å¦‚æœæ˜¯ TCP/UDPï¼Œåˆ™ä¸ºç©ºã€‚
</span></span><span class=line><span class=cl>  <span class=s2>&#34;response_code&#34;</span>: 200, // HTTPå“åº”çŠ¶æ€ç 
</span></span><span class=line><span class=cl>  <span class=s2>&#34;response_flags&#34;</span>: <span class=s2>&#34;-&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;response_code_details&#34;</span>: <span class=s2>&#34;via_upstream&#34;</span>, // HTTPå“åº”çŠ¶æ€ç è¯¦æƒ…ï¼Œæ¯”å¦‚ï¼šè°è®¾ç½®çš„æ­¤å€¼
</span></span><span class=line><span class=cl>  <span class=s2>&#34;connection_termination_details&#34;</span>: <span class=s2>&#34;-&#34;</span>, // Envoy ç»ˆæ­¢è¯·æ±‚çš„L4å±‚åŸå› 
</span></span><span class=line><span class=cl>  <span class=s2>&#34;upstream_transport_failure_reason&#34;</span>: <span class=s2>&#34;-&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;bytes_received&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;bytes_send&#34;</span>: 60,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;duration&#34;</span>: 0, // ä»è¯·æ±‚å¼€å§‹æ—¶é—´åˆ°æœ€åä¸€ä¸ªå­—èŠ‚å‘å‡ºçš„æ—¶é—´è·¨åº¦
</span></span><span class=line><span class=cl>  <span class=s2>&#34;x-envoy-upstream-service-time&#34;</span>: 0, // å“åº”æŠ¥æ–‡ä¸­ X-ENVOY-UPSTREAM-SERVICE-TIME é¦–éƒ¨çš„å€¼
</span></span><span class=line><span class=cl>  <span class=s2>&#34;x-forwarded-for&#34;</span>: <span class=s2>&#34;-&#34;</span>, // è¯·æ±‚æŠ¥æ–‡ä¸­ X-FORWARDED-FOR é¦–éƒ¨çš„å€¼
</span></span><span class=line><span class=cl>  <span class=s2>&#34;user-agent&#34;</span>: <span class=s2>&#34;Go-http-client/1.1&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;x-request-id&#34;</span>: <span class=s2>&#34;a67101af-e469-91ab-99b0-61bb5abfa108&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;authority&#34;</span>: <span class=s2>&#34;simple-server-svc.demo-to:18080&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;upstream_host&#34;</span>: <span class=s2>&#34;10.20.0.77:18080&#34;</span>, // Envoy Sidecar è¦è®¿é—®çš„æœåŠ¡åœ°å€ã€‚è¿™é‡Œå°±æ˜¯Podé‡Œçš„istio-proxyè¦è®¿é—®çš„åŒPodé‡Œä¸šåŠ¡å®¹å™¨
</span></span><span class=line><span class=cl>  <span class=s2>&#34;upstream_cluster&#34;</span>: <span class=s2>&#34;inbound|18080||&#34;</span>, // ä¸Šæ¸¸æœåŠ¡åœ°å€
</span></span><span class=line><span class=cl>  <span class=s2>&#34;upstream_local_address&#34;</span>: <span class=s2>&#34;127.0.0.6:44213&#34;</span>, // æœåŠ¡ç«¯ Envoy è¿æ¥æœåŠ¡ç«¯æ—¶ï¼ŒEnvoy çš„æœ¬åœ°åœ°å€ï¼ˆæ­¤æ—¶æœåŠ¡ç«¯è·å¾—çš„ IP åœ°å€æ˜¯è¿™ä¸ªï¼‰
</span></span><span class=line><span class=cl>  <span class=s2>&#34;downstream_local_address&#34;</span>: <span class=s2>&#34;10.20.0.77:18080&#34;</span>, // ä¸‹æ¸¸è¿æ¥ä¸­ï¼Œå½“å‰ Envoy çš„æœ¬åœ°åœ°å€ã€‚å®¢æˆ·ç«¯è¦è¿çš„åœ°å€
</span></span><span class=line><span class=cl>  <span class=s2>&#34;downstream_remote_address&#34;</span>: <span class=s2>&#34;10.20.0.78:33204&#34;</span>, // ä¸‹æ¸¸è¿æ¥ä¸­è¿œç«¯åœ°å€ã€‚å¯¹äº Inbound æµé‡ï¼Œæ­¤å€¼æ˜¯ã€Œä¸‹æ¸¸ pod-ip : éšæœºç«¯å£ã€
</span></span><span class=line><span class=cl>  <span class=s2>&#34;requested_server_name&#34;</span>: <span class=s2>&#34;outbound_.18080_._.simple-server-svc.demo-to.svc.cluster.local&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;route_name&#34;</span>:<span class=s2>&#34;default&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>æµé‡äº”å…ƒç»„</strong></p><p>æµé‡äº”å…ƒç»„ä¿¡æ¯æ˜¯ Envoy æ—¥å¿—é‡Œæœ€é‡è¦çš„éƒ¨åˆ†<sup id=fnref1:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup><sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>ï¼ŒåŒ…å«ï¼š</p><ul><li><strong>UPSTREAM_CLUSTER</strong>ï¼šEnvoy è®¡ç®—å‡ºç¬¦åˆæ¡ä»¶çš„è½¬å‘ç›®çš„ä¸»æœºé›†åˆï¼Œè¿™ä¸ªé›†åˆå«åš UPSTREAM_CLUSTER, å¹¶æ ¹æ®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä»è¿™ä¸ªé›†åˆä¸­é€‰æ‹©ä¸€ä¸ª host ä½œä¸ºæµé‡è½¬å‘çš„æ¥æ”¶ç«¯ç‚¹ï¼›</li><li><strong>UPSTREAM_HOST</strong>ï¼šä¸Šé¢é€‰æ‹©çš„è¿™ä¸ªç«¯ç‚¹å°±å« UPSTREAM_HOSTï¼›</li><li><strong>UPSTREAM_LOCAL_ADDRESS</strong>ï¼šä¸Šæ¸¸è¿æ¥ä¸­ï¼Œå½“å‰ Envoy çš„æœ¬åœ°åœ°å€ï¼Œæ­¤å€¼æ˜¯ã€Œå½“å‰ pod-ip : éšæœºç«¯å£ã€ï¼›</li><li><strong>DOWNSTREAM_LOCAL_ADDRESS</strong>ï¼šä¸‹æ¸¸è¿æ¥ä¸­ï¼Œå½“å‰ Envoy çš„æœ¬åœ°åœ°å€ã€‚å³ï¼Œä¸‹æ¸¸è¯·æ±‚æ–¹è¦è¿æ¥çš„åœ°å€ï¼›</li><li><strong>DOWNSTREAM_REMOTE_ADDRESS</strong>ï¼šä¸‹æ¸¸è¿æ¥ä¸­è¿œç«¯åœ°å€ã€‚å³ï¼Œä¸‹æ¸¸è¯·æ±‚æ–¹çš„åœ°å€ã€‚</li></ul><p><img src=/images/envoy-model-1.png alt></p><p><img src=/images/envoy-model-2.png alt></p><p><img src=/images/envoy-model-3.png alt></p><p>ä¸€äº›å…¶ä»– Istio è¿ç»´æ–‡ç« <sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup></p><p>æ ¹æ®ä¸Šé¢ä»‹ç»çš„æ—¥å¿—å­—æ®µå’Œæµé‡äº”å…ƒç»„ï¼Œå¯ä»¥çŸ¥é“ï¼ŒæœåŠ¡ç«¯Podé‡Œçš„ server ç¨‹åºï¼Œçœ‹åˆ°çš„è¯·æ±‚è¿‡æ¥çš„å®¢æˆ·ç«¯æº IP åœ°å€æ˜¯ UPSTREAM_LOCAL_ADDRESSï¼š127.0.0.6ã€‚</p><h3 id=2-æŸ¥çœ‹-iptables-è§„åˆ™>2. æŸ¥çœ‹ iptables è§„åˆ™</h3><p>æŸ¥çœ‹ iptables é…ç½®ï¼Œåˆ—å‡º NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰è¡¨çš„æ‰€æœ‰è§„åˆ™ï¼Œå› ä¸ºåœ¨ Init å®¹å™¨å¯åŠ¨çš„æ—¶å€™é€‰æ‹©ç»™ istio-iptables.sh<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup> ä¼ é€’çš„å‚æ•°ä¸­æŒ‡å®šå°†å…¥ç«™æµé‡é‡å®šå‘åˆ° Envoy çš„æ¨¡å¼ä¸º â€œREDIRECTâ€ï¼Œå› æ­¤åœ¨ iptables ä¸­å°†åªæœ‰ NAT è¡¨çš„è§„æ ¼é…ç½®ï¼Œå¦‚æœé€‰æ‹© TPROXY è¿˜ä¼šæœ‰ mangle è¡¨é…ç½®<sup id=fnref:9><a href=#fn:9 class=footnote-ref role=doc-noteref>9</a></sup>ã€‚</p><p>æŸ¥çœ‹å®¹å™¨ iptablesï¼Œéœ€è¦å…ˆè¿›å…¥å®¹å™¨ network namespaceï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># æŸ¥å®¹å™¨ID</span>
</span></span><span class=line><span class=cl>$ kubectl get po -n demo-to simple-server-56b4d7b7d-9zkbm -ojson <span class=p>|</span> jq <span class=s1>&#39;.status.containerStatuses[] | {name,containerID}&#39;</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;demo&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;containerID&#34;</span>: <span class=s2>&#34;docker://cbd30c99c9f65430e32d2d0d46d4f0a56d261a4585d2a11385dc7ba994c9c948&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;istio-proxy&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;containerID&#34;</span>: <span class=s2>&#34;docker://a9cb6d70894c71102174cb8250a3de87d230e1586723938bf0a9ff1db7675969&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åœ¨å®¹å™¨æ‰€åœ¨èŠ‚ç‚¹ï¼Œæ‰§è¡Œdocker inspect</span>
</span></span><span class=line><span class=cl>$ docker inspect -f <span class=o>{{</span>.State.Pid<span class=o>}}</span> cbd30c99c9
</span></span><span class=line><span class=cl><span class=m>188902</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¿›å…¥å®¹å™¨ network namespace åï¼Œå°±å¯ä»¥æ‰§è¡Œ ipstables äº†</span>
</span></span><span class=line><span class=cl>$ nsenter --target <span class=m>188902</span> -n
</span></span></code></pre></td></tr></table></div></div><p>iptables å‘½ä»¤ä½¿ç”¨è¯´æ˜<sup id=fnref:10><a href=#fn:10 class=footnote-ref role=doc-noteref>10</a></sup>ï¼Œiptables å†…ç½®äº†5å¼ è¡¨ï¼Œåˆ†åˆ«æ˜¯ rawã€ natã€ mangleã€ filterã€ securityã€‚æ­¤å¤„åªéœ€è¦å…³æ³¨ OUTPUT é“¾<sup id=fnref:11><a href=#fn:11 class=footnote-ref role=doc-noteref>11</a></sup>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># æŸ¥çœ‹ NAT è¡¨ä¸­è§„åˆ™é…ç½®çš„è¯¦ç»†ä¿¡æ¯</span>
</span></span><span class=line><span class=cl>$ iptables -t nat -L -v
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># PREROUTING é“¾ï¼šç”¨äºç›®æ ‡åœ°å€è½¬æ¢ï¼ˆDNATï¼‰ï¼Œå°†æ‰€æœ‰å…¥ç«™ TCP æµé‡è·³è½¬åˆ° ISTIO_INBOUND é“¾ä¸Š</span>
</span></span><span class=line><span class=cl>Chain PREROUTING <span class=o>(</span>policy ACCEPT <span class=m>11627</span> packets, 698K bytes<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=c1># pkts å¤šå°‘ä¸ªæŠ¥æ–‡æ•°é‡åŒ¹é…è¯¥è§„åˆ™ï¼Œbytes æŠ¥æ–‡å¤§å°ï¼Œtarget åŠ¨ä½œï¼Œport åè®®ï¼Œopt é€‰é¡¹ï¼Œin/out: å…¥ã€å‡ºå£ç½‘å¡ï¼Œsource/destination: æºã€ç›®æ ‡ip/ipæ®µ</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl><span class=m>11627</span>  698K ISTIO_INBOUND  tcp  --  any    any     anywhere             anywhere            
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># INPUT é“¾ï¼šå¤„ç†è¾“å…¥æ•°æ®åŒ…ï¼Œç›®å‰æ²¡æœ‰é…ç½®è§„åˆ™</span>
</span></span><span class=line><span class=cl>Chain INPUT <span class=o>(</span>policy ACCEPT <span class=m>11627</span> packets, 698K bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># OUTPUT é“¾ï¼šå°†æ‰€æœ‰å‡ºç«™æ•°æ®åŒ…è·³è½¬åˆ° ISTIO_OUTPUT é“¾ä¸Š</span>
</span></span><span class=line><span class=cl>Chain OUTPUT <span class=o>(</span>policy ACCEPT <span class=m>1059</span> packets, <span class=m>96140</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>   <span class=m>44</span>  <span class=m>2640</span> ISTIO_OUTPUT  tcp  --  any    any     anywhere             anywhere            
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># POSTROUTING é“¾ï¼šæ‰€æœ‰æ•°æ®åŒ…æµå‡ºç½‘å¡æ—¶éƒ½è¦å…ˆè¿›å…¥POSTROUTING é“¾ï¼Œå†…æ ¸æ ¹æ®æ•°æ®åŒ…ç›®çš„åœ°åˆ¤æ–­æ˜¯å¦éœ€è¦è½¬å‘å‡ºå»ï¼Œæˆ‘ä»¬çœ‹åˆ°æ­¤å¤„æœªåšä»»ä½•å¤„ç†</span>
</span></span><span class=line><span class=cl>Chain POSTROUTING <span class=o>(</span>policy ACCEPT <span class=m>1060</span> packets, <span class=m>96200</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ISTIO_INBOUND é“¾ï¼šå°†æ‰€æœ‰å…¥ç«™æµé‡é‡å®šå‘åˆ° ISTIO_IN_REDIRECT é“¾ä¸Š</span>
</span></span><span class=line><span class=cl><span class=c1># ä½†é™¤äº† 15008ã€22ã€15090ã€15021ã€15020 ç«¯å£</span>
</span></span><span class=line><span class=cl>Chain ISTIO_INBOUND <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15008
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15090
</span></span><span class=line><span class=cl><span class=m>11627</span>  698K RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15021
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15020
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> ISTIO_IN_REDIRECT  tcp  --  any    any     anywhere             anywhere            
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ISTIO_IN_REDIRECT é“¾ï¼šå°†æ‰€æœ‰çš„å…¥ç«™æµé‡è·³è½¬åˆ°æœ¬åœ°çš„ 15006 ç«¯å£ï¼Œè‡³æ­¤æˆåŠŸçš„æ‹¦æˆªäº†æµé‡åˆ° Envoy </span>
</span></span><span class=line><span class=cl>Chain ISTIO_IN_REDIRECT <span class=o>(</span><span class=m>3</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports <span class=m>15006</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ISTIO_OUTPUT é“¾ï¼šé€‰æ‹©éœ€è¦é‡å®šå‘åˆ° Envoyï¼ˆå³æœ¬åœ°ï¼‰ çš„å‡ºç«™æµé‡ï¼Œæ‰€æœ‰é localhost çš„æµé‡å…¨éƒ¨è½¬å‘åˆ° ISTIO_REDIRECTã€‚ä¸ºäº†é¿å…æµé‡åœ¨è¯¥ Pod ä¸­æ— é™å¾ªç¯ï¼Œæ‰€æœ‰åˆ° istio-proxy ç”¨æˆ·ç©ºé—´çš„æµé‡éƒ½è¿”å›åˆ°å®ƒçš„è°ƒç”¨ç‚¹ä¸­çš„ä¸‹ä¸€æ¡è§„åˆ™ï¼Œæœ¬ä¾‹ä¸­å³ OUTPUT é“¾ï¼Œå› ä¸ºè·³å‡º ISTIO_OUTPUT è§„åˆ™ä¹‹åå°±è¿›å…¥ä¸‹ä¸€æ¡é“¾ POSTROUTINGã€‚å¦‚æœç›®çš„åœ°é localhost å°±è·³è½¬åˆ° ISTIO_REDIRECTï¼›å¦‚æœæµé‡æ˜¯æ¥è‡ª istio-proxy ç”¨æˆ·ç©ºé—´çš„ï¼Œé‚£ä¹ˆå°±è·³å‡ºè¯¥é“¾ï¼Œè¿”å›å®ƒçš„è°ƒç”¨é“¾ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡è§„åˆ™ï¼ˆOUTPUT çš„ä¸‹ä¸€æ¡è§„åˆ™ï¼Œæ— éœ€å¯¹æµé‡è¿›è¡Œå¤„ç†ï¼‰ï¼›æ‰€æœ‰çš„é istio-proxy ç”¨æˆ·ç©ºé—´çš„ç›®çš„åœ°æ˜¯ localhost çš„æµé‡å°±è·³è½¬åˆ° ISTIO_REDIRECT</span>
</span></span><span class=line><span class=cl>Chain ISTIO_OUTPUT <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    lo      127.0.0.6            anywhere       
</span></span><span class=line><span class=cl><span class=c1># è¿™é‡Œ 1337 æ˜¯ istio-proxy çš„ Group IDï¼ˆrunAsGroup: 1337ï¼‰</span>
</span></span><span class=line><span class=cl><span class=c1># è¦è¯†åˆ«å‡ºå“ªäº›æµé‡æ˜¯ç”± envoy å‘å‡ºçš„ï¼Œè¿™é‡Œä½¿ç”¨äº† UID æ¥æ ‡è®°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®è®© envoy æ€»æ˜¯ç”±ç‰¹å®šçš„ UID å¯åŠ¨ï¼Œè¿™æ ·å°±èƒ½å¤Ÿåœ¨ iptables ä¸­é€šè¿‡ owner UID match æ¥è¿‡æ»¤å‡ºç”± envoy å‘å‡ºçš„æµé‡[^12]ã€‚     </span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner UID match <span class=m>1337</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    lo      anywhere             anywhere             ! owner UID match <span class=m>1337</span>
</span></span><span class=line><span class=cl>   <span class=m>43</span>  <span class=m>2580</span> RETURN     all  --  any    any     anywhere             anywhere             owner UID match <span class=m>1337</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner GID match <span class=m>1337</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    lo      anywhere             anywhere             ! owner GID match <span class=m>1337</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    any     anywhere             anywhere             owner GID match <span class=m>1337</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    any     anywhere             localhost           
</span></span><span class=line><span class=cl>    <span class=m>1</span>    <span class=m>60</span> ISTIO_REDIRECT  all  --  any    any     anywhere             anywhere            
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ISTIO_REDIRECT é“¾ï¼šå°†æ‰€æœ‰æµé‡é‡å®šå‘åˆ° Envoyï¼ˆå³æœ¬åœ°ï¼‰ çš„ 15001 ç«¯å£</span>
</span></span><span class=line><span class=cl>Chain ISTIO_REDIRECT <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>    <span class=m>1</span>    <span class=m>60</span> REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports <span class=m>15001</span>
</span></span></code></pre></td></tr></table></div></div><p>é€šè¿‡ iptables é…ç½®ï¼Œå¯ä»¥çŸ¥é“ï¼Œå‘å¾€æœåŠ¡ç«¯ç¨‹åºçš„è¯·æ±‚ï¼Œæœ€ç»ˆå…ˆè¢« Envoy çš„ 15006 ç«¯å£æ¥æ”¶ï¼›æœåŠ¡ç«¯è¿”å›çš„å“åº”ï¼Œå…ˆè¢« Envoy çš„ 15001 ç«¯å£å¤„ç†ã€‚è¿™ä¹Ÿä¼š istio-init çš„å¦‚ä½•åˆå§‹åŒ– iptables ä¸€è‡´<sup id=fnref1:9><a href=#fn:9 class=footnote-ref role=doc-noteref>9</a></sup>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get po -n demo-to simple-server-86b499d4dd-bjrjz  -ojson <span class=p>|</span> jq .spec.initContainers<span class=o>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;istio-init&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;image&#34;</span>: <span class=s2>&#34;docker.io/istio/proxyv2:1.11.3&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;args&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;istio-iptables&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;-p&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;15001&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;-z&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;15006&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;-u&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;1337&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;-m&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;REDIRECT&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;-i&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;*&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;-x&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;-b&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;*&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;-d&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;15090,15021,15020&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;securityContext&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;allowPrivilegeEscalation&#34;</span>: false,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;privileged&#34;</span>: false,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;readOnlyRootFilesystem&#34;</span>: false,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;runAsGroup&#34;</span>: 0,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;runAsNonRoot&#34;</span>: false,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;runAsUser&#34;</span>: <span class=m>0</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å› æ­¤ï¼Œè¦ææ¸…æ¥šä¸ºä»€ä¹ˆæ˜¯æœåŠ¡ç«¯çœ‹åˆ°çš„æ˜¯ 127.0.0.6ï¼Œå°±è¦çœ‹ Envoy çš„é…ç½®äº†ã€‚</p><h3 id=3-istio-config-æŸ¥çœ‹-envoy-é…ç½®>3. istio-config æŸ¥çœ‹ Envoy é…ç½®</h3><p>æ¥ç€ä¸Šé¢çš„åˆ†æï¼Œç”±äºæ‰€æœ‰çš„ 18080 ç«¯å£çš„è¯·æ±‚ï¼Œéƒ½è¢« iptables å‘å¾€ 15006 ç«¯å£ï¼Œç°åœ¨æ¥çœ‹ 15006 ç«¯å£çš„ Envoy é…ç½®ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ istioctl proxy-config listener -n demo-to simple-server-86b499d4dd-bjrjz --port<span class=o>=</span><span class=m>15006</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ADDRESS PORT  MATCH                                                                    DESTINATION
</span></span><span class=line><span class=cl>0.0.0.0 <span class=m>15006</span> Addr: *:15006                                                            Non-HTTP/Non-TCP
</span></span><span class=line><span class=cl>0.0.0.0 <span class=m>15006</span> Trans: tls<span class=p>;</span> App: istio-http/1.0,istio-http/1.1,istio-h2<span class=p>;</span> Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4
</span></span><span class=line><span class=cl>0.0.0.0 <span class=m>15006</span> Trans: raw_buffer<span class=p>;</span> App: HTTP<span class=p>;</span> Addr: 0.0.0.0/0                            InboundPassthroughClusterIpv4
</span></span><span class=line><span class=cl>0.0.0.0 <span class=m>15006</span> Trans: tls<span class=p>;</span> App: TCP TLS<span class=p>;</span> Addr: 0.0.0.0/0                                InboundPassthroughClusterIpv4
</span></span><span class=line><span class=cl>0.0.0.0 <span class=m>15006</span> Trans: raw_buffer<span class=p>;</span> Addr: 0.0.0.0/0                                       InboundPassthroughClusterIpv4
</span></span><span class=line><span class=cl>0.0.0.0 <span class=m>15006</span> Trans: tls<span class=p>;</span> Addr: 0.0.0.0/0                                              InboundPassthroughClusterIpv4
</span></span><span class=line><span class=cl>0.0.0.0 <span class=m>15006</span> Trans: tls<span class=p>;</span> App: istio-http/1.0,istio-http/1.1,istio-h2<span class=p>;</span> Addr: *:18080   Cluster: inbound<span class=p>|</span>18080<span class=o>||</span>
</span></span><span class=line><span class=cl>0.0.0.0 <span class=m>15006</span> Trans: raw_buffer<span class=p>;</span> App: HTTP<span class=p>;</span> Addr: *:18080                              Cluster: inbound<span class=p>|</span>18080<span class=o>||</span>
</span></span><span class=line><span class=cl>0.0.0.0 <span class=m>15006</span> Trans: tls<span class=p>;</span> App: TCP TLS<span class=p>;</span> Addr: *:18080                                  Cluster: inbound<span class=p>|</span>18080<span class=o>||</span>
</span></span><span class=line><span class=cl>0.0.0.0 <span class=m>15006</span> Trans: raw_buffer<span class=p>;</span> Addr: *:18080                                         Cluster: inbound<span class=p>|</span>18080<span class=o>||</span>
</span></span><span class=line><span class=cl>0.0.0.0 <span class=m>15006</span> Trans: tls<span class=p>;</span> Addr: *:18080                                                Cluster: inbound<span class=p>|</span>18080<span class=o>||</span>
</span></span></code></pre></td></tr></table></div></div><p>æµé‡è·¯ç”±åˆ†ä¸º Inbound å’Œ Outbound ä¸¤ä¸ªè¿‡ç¨‹ï¼Œä¸‹é¢å°†æ ¹æ®ä¸Šæ–‡ä¸­çš„ç¤ºä¾‹åŠ sidecar çš„é…ç½®ä¸ºè¯»è€…è¯¦ç»†åˆ†ææ­¤è¿‡ç¨‹<sup id=fnref:12><a href=#fn:12 class=footnote-ref role=doc-noteref>12</a></sup>ã€‚</p><p><strong>ç†è§£ Inbound Handler</strong></p><p>ä»è¯¥ Pod çš„ Listener åˆ—è¡¨çš„æœ€åä¸¤è¡Œä¸­å¯ä»¥çœ‹åˆ°ï¼Œ0.0.0.0:15006/TCP çš„ Listenerï¼ˆå…¶å®é™…åå­—æ˜¯ virtualInboundï¼‰ç›‘å¬æ‰€æœ‰çš„ Inbound æµé‡ï¼Œå…¶ä¸­åŒ…å«äº†åŒ¹é…è§„åˆ™ï¼Œæ¥è‡ªä»»æ„ IP çš„å¯¹ 18080 ç«¯å£çš„è®¿é—®æµé‡ï¼Œå°†ä¼šè·¯ç”±åˆ° inbound|18080|| Clusterï¼Œå¦‚æœä½ æƒ³ä»¥ Json æ ¼å¼æŸ¥çœ‹è¯¥ Listener çš„è¯¦ç»†é…ç½®ï¼Œå¯ä»¥æ‰§è¡Œ istioctl proxy-config listeners -n demo-to simple-server-86b499d4dd-bjrjz &ndash;port 15006 -o json å‘½ä»¤ï¼Œä½ å°†è·å¾—ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>  <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;virtualInbound&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;address&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;socketAddress&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;address&#34;</span>: <span class=s2>&#34;0.0.0.0&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;portValue&#34;</span>: <span class=m>15006</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;filterChains&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filterChainMatch&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;destinationPort&#34;</span>: <span class=m>15006</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filters&#34;</span>: <span class=o>[{</span>
</span></span><span class=line><span class=cl>          <span class=c1># ... çœç•¥</span>
</span></span><span class=line><span class=cl>        <span class=o>}]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;virtualInbound-blackhole&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=c1># ... çœç•¥</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filterChainMatch&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;destinationPort&#34;</span>: 18080,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;transportProtocol&#34;</span>: <span class=s2>&#34;raw_buffer&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filters&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;envoy.filters.network.tcp_proxy&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;typedConfig&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;@type&#34;</span>: <span class=s2>&#34;type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy&#34;</span>,
</span></span><span class=line><span class=cl>              <span class=s2>&#34;statPrefix&#34;</span>: <span class=s2>&#34;inbound|18080||&#34;</span>,
</span></span><span class=line><span class=cl>              <span class=s2>&#34;cluster&#34;</span>: <span class=s2>&#34;inbound|18080||&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;0.0.0.0_18080&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>é€šè¿‡ envoy.filters.network.tcp_proxyï¼ŒçŸ¥é“è¯·æ±‚ 15006 æ”¶åˆ°çš„è¯·æ±‚ï¼Œä¼šå‘å¾€ 0.0.0.0_18080 Cluserã€‚ç»§ç»­æŸ¥çœ‹ 0.0.0.0_18080 Cluster çš„é…ç½®è§„åˆ™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ istioctl proxy-config cluster -n demo-to simple-server-86b499d4dd-bjrjz --fqdn <span class=s2>&#34;inbound|18080||&#34;</span> 
</span></span><span class=line><span class=cl>SERVICE FQDN     PORT      SUBSET     DIRECTION     TYPE             DESTINATION RULE
</span></span><span class=line><span class=cl>                 <span class=m>18080</span>     -          inbound       ORIGINAL_DST     
</span></span></code></pre></td></tr></table></div></div><p>TYPE ä¸º ORIGINAL_DSTï¼Œè¡¨ç¤ºå°†æµé‡å‘é€åˆ°åŸå§‹ç›®æ ‡åœ°å€ï¼ˆPod IPï¼‰ï¼Œå› ä¸ºåŸå§‹ç›®æ ‡åœ°å€å³å½“å‰ Podã€‚åº”è¯¥æ³¨æ„åˆ° upstreamBindConfig.sourceAddress.address çš„å€¼è¢«æ”¹å†™ä¸ºäº† 127.0.0.6ï¼Œè€Œä¸”å¯¹äº Pod å†…æµé‡æ˜¯é€šè¿‡ lo ç½‘å¡å‘é€çš„ï¼Œè¿™åˆšå¥½å‘¼åº”äº†ä¸Šæ–‡ä¸­çš„ iptables ISTIO_OUTPUT é“¾ä¸­çš„ç¬¬ä¸€æ¡è§„åˆ™ï¼Œæ ¹æ®è¯¥è§„åˆ™ï¼Œæµé‡å°†è¢«é€ä¼ åˆ° Pod å†…çš„åº”ç”¨å®¹å™¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ istioctl proxy-config cluster -n demo-to simple-server-86b499d4dd-bjrjz --fqdn <span class=s2>&#34;inbound|18080||&#34;</span>  -ojson
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;inbound|18080||&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;ORIGINAL_DST&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;connectTimeout&#34;</span>: <span class=s2>&#34;10s&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lbPolicy&#34;</span>: <span class=s2>&#34;CLUSTER_PROVIDED&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;circuitBreakers&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;thresholds&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;maxConnections&#34;</span>: 4294967295,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;maxPendingRequests&#34;</span>: 4294967295,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;maxRequests&#34;</span>: 4294967295,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;maxRetries&#34;</span>: 4294967295,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;trackRemaining&#34;</span>: <span class=nb>true</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;typedExtensionProtocolOptions&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;@type&#34;</span>: <span class=s2>&#34;type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;</span>,
</span></span><span class=line><span class=cl>                <span class=s2>&#34;useDownstreamProtocolConfig&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;httpProtocolOptions&#34;</span>: <span class=o>{}</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;http2ProtocolOptions&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;maxConcurrentStreams&#34;</span>: <span class=m>1073741824</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;cleanupInterval&#34;</span>: <span class=s2>&#34;60s&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;upstreamBindConfig&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;sourceAddress&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;address&#34;</span>: <span class=s2>&#34;127.0.0.6&#34;</span>,
</span></span><span class=line><span class=cl>                <span class=s2>&#34;portValue&#34;</span>: <span class=m>0</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;metadata&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;filterMetadata&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;istio&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;services&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;host&#34;</span>: <span class=s2>&#34;simple-server-svc.demo-to.svc.cluster.local&#34;</span>,
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;simple-server-svc&#34;</span>,
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;namespace&#34;</span>: <span class=s2>&#34;demo-to&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“ï¼Œ127.0.0.6 æ˜¯ Envoy ç»‘å®šçš„åœ°å€ã€‚é‚£å¦‚ä½•è§£å†³äº†ï¼Ÿ</p><h2 id=è§£å†³åŠæ³•>è§£å†³åŠæ³•</h2><p>è§£å†³åŠæ³•å¾ˆç®€å•ï¼Œåªéœ€è¦ Istio çš„ interceptionMode æ¨¡å¼ä»é»˜è®¤ REDIRECT åˆ‡æ¢ä¸º TPROXYï¼Œå…·ä½“å¯ä»¥å‚è€ƒé˜¿é‡Œäº‘çš„æ–‡æ¡£<sup id=fnref:13><a href=#fn:13 class=footnote-ref role=doc-noteref>13</a></sup>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl patch deployment -n demo-to simple-server  -p <span class=s1>&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;metadata&#34;:{&#34;annotations&#34;:{&#34;sidecar.istio.io/interceptionMode&#34;:&#34;TPROXY&#34;}}}}}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>æŸ¥çœ‹ä¿®æ”¹åçš„ iptablesï¼ˆä»è¦å…ˆè¿›å…¥å®¹å™¨çš„ namespaceï¼Œå†æ‰§è¡Œ iptables å‘½ä»¤ï¼‰ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ iptables -t mangle -L -v
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¯ä»¥çœ‹åˆ°ï¼Œæ‹¦æˆªçš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä»…ä»…æ”¹äº† PREROUTING ï¼ˆå…³æ³¨è¿›å…¥çš„å°åŒ…ï¼‰é“¾</span>
</span></span><span class=line><span class=cl>Chain PREROUTING <span class=o>(</span>policy ACCEPT <span class=m>31760</span> packets, 7988K bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl><span class=m>40639</span>   14M ISTIO_INBOUND  tcp  --  any    any     anywhere             anywhere            
</span></span><span class=line><span class=cl><span class=m>12304</span> 3649K CONNMARK   tcp  --  any    any     anywhere             anywhere             mark match 0x539 CONNMARK and 0x0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain INPUT <span class=o>(</span>policy ACCEPT <span class=m>41248</span> packets, 14M bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain FORWARD <span class=o>(</span>policy ACCEPT <span class=m>0</span> packets, <span class=m>0</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain OUTPUT <span class=o>(</span>policy ACCEPT <span class=m>32921</span> packets, 13M bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl> <span class=m>8202</span> 2747K RETURN     tcp  --  any    lo      anywhere             anywhere             mark match 0x539
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> MARK       tcp  --  any    lo      anywhere            !localhost            owner UID match <span class=m>1337</span> MARK <span class=nb>set</span> 0x53a
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> MARK       tcp  --  any    lo      anywhere            !localhost            owner GID match <span class=m>1337</span> MARK <span class=nb>set</span> 0x53a
</span></span><span class=line><span class=cl> <span class=m>4102</span>  902K CONNMARK   tcp  --  any    any     anywhere             anywhere             connmark match  0x539 CONNMARK and 0x0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain POSTROUTING <span class=o>(</span>policy ACCEPT <span class=m>32921</span> packets, 13M bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain ISTIO_DIVERT <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl> <span class=m>9487</span> 6308K MARK       all  --  any    any     anywhere             anywhere             MARK <span class=nb>set</span> 0x539
</span></span><span class=line><span class=cl> <span class=m>9487</span> 6308K ACCEPT     all  --  any    any     anywhere             anywhere            
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain ISTIO_INBOUND <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl><span class=m>12304</span> 3649K RETURN     tcp  --  any    any     anywhere             anywhere             mark match 0x539
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     tcp  --  lo     any     127.0.0.6            anywhere            
</span></span><span class=line><span class=cl> <span class=m>6516</span> 3339K RETURN     tcp  --  lo     any     anywhere             anywhere             mark match ! 0x53a
</span></span><span class=line><span class=cl> <span class=c1># ä¸æ‹¦æˆªç‰¹æ®Šç«¯å£ </span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15090
</span></span><span class=line><span class=cl><span class=m>12331</span>  898K RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15021
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15020
</span></span><span class=line><span class=cl> <span class=c1># å¦‚æœSRC_IP:SRC_PORT:DST_IP:DST_PORTå·²ç»å»ºç«‹æ‹¦æˆªï¼Œåˆ™æ‰“æ ‡è®°ï¼Œæ¥å—å°åŒ…</span>
</span></span><span class=line><span class=cl> <span class=m>9487</span> 6308K ISTIO_DIVERT  tcp  --  any    any     anywhere             anywhere             ctstate RELATED,ESTABLISHED
</span></span><span class=line><span class=cl> <span class=c1># å¦åˆ™ï¼Œå¦‚æœç›®çš„åœ°ä¸æ˜¯127.0.0.1ï¼Œåˆ™é‡å®šå‘ç»™Envoy</span>
</span></span><span class=line><span class=cl>    <span class=m>1</span>    <span class=m>60</span> ISTIO_TPROXY  tcp  --  any    any     anywhere             anywhere            
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¯¹äºç›®çš„åœ°å€ä¸æ˜¯127.0.0.1çš„å°åŒ…ï¼Œè¿›è¡Œé€æ˜ä»£ç†ï¼Œå‘é€ç»™Envoyçš„15006ç›‘å¬å™¨ï¼Œç»™å°åŒ…æ‰“æ ‡è®°1337ï¼ˆåå…­è¿›åˆ¶æ˜¯0x539ï¼‰</span>
</span></span><span class=line><span class=cl>Chain ISTIO_TPROXY <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>    <span class=m>1</span>    <span class=m>60</span> TPROXY     tcp  --  any    any     anywhere            !localhost            TPROXY redirect 0.0.0.0:15006 mark 0x539/0xffffffff
</span></span></code></pre></td></tr></table></div></div><p>çœ‹å®Œ TPROXY1 ä¿®æ”¹çš„ mangleï¼Œå†çœ‹ä¸‹ natï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ iptables -t nat  -L -v
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain PREROUTING <span class=o>(</span>policy ACCEPT <span class=m>2842</span> packets, 171K bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain INPUT <span class=o>(</span>policy ACCEPT <span class=m>2842</span> packets, 171K bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain OUTPUT <span class=o>(</span>policy ACCEPT <span class=m>294</span> packets, <span class=m>25636</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>   <span class=m>25</span>  <span class=m>1500</span> ISTIO_OUTPUT  tcp  --  any    any     anywhere             anywhere            
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain POSTROUTING <span class=o>(</span>policy ACCEPT <span class=m>294</span> packets, <span class=m>25636</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain ISTIO_INBOUND <span class=o>(</span><span class=m>0</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15008
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain ISTIO_IN_REDIRECT <span class=o>(</span><span class=m>2</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports <span class=m>15006</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain ISTIO_OUTPUT <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    lo      127.0.0.6            anywhere            
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner UID match <span class=m>1337</span>
</span></span><span class=line><span class=cl>   <span class=m>13</span>   <span class=m>780</span> RETURN     all  --  any    lo      anywhere             anywhere             ! owner UID match <span class=m>1337</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    any     anywhere             anywhere             owner UID match <span class=m>1337</span>
</span></span><span class=line><span class=cl><span class=c1># æ ¹æ®ç”¨æˆ·ä¸åŒå†³å®šè¡Œä¸ºï¼Œå¦‚æœGIDä¸º1337ï¼Œæ„å‘³ç€æ˜¯Envoyè¿›ç¨‹å‘èµ·çš„å°åŒ…ï¼Œå¦åˆ™æ˜¯å…¶å®ƒè¿›ç¨‹å‘èµ·çš„</span>
</span></span><span class=line><span class=cl><span class=c1># å¯¹äºå°†ä»loå‘å‡ºçš„å°åŒ…ï¼Œå¦‚æœç”¨æˆ·æ˜¯Envoyï¼Œç›®çš„åœ°å€é127.0.0.1çš„ï¼Œåˆ™é‡å®šå‘åˆ°å…¥ç«™è™šæ‹Ÿç›‘å¬å™¨15006</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner GID match <span class=m>1337</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    lo      anywhere             anywhere             ! owner GID match <span class=m>1337</span>
</span></span><span class=line><span class=cl>   <span class=m>12</span>   <span class=m>720</span> RETURN     all  --  any    any     anywhere             anywhere             owner GID match <span class=m>1337</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    any     anywhere             localhost           
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> ISTIO_REDIRECT  all  --  any    any     anywhere             anywhere            
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># çœ‹æ ·å­15006æ˜¯éœ€è¦å°†æ‰€æœ‰å…¥ç«™æµé‡é‡å®šå‘åˆ°çš„ç«¯å£ï¼Œè€Œåœ¨TPROXYä¸­å°†å…¥ç«™æµé‡éƒ½é‡å®šå‘åˆ°15001</span>
</span></span><span class=line><span class=cl>Chain ISTIO_REDIRECT <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination         
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports <span class=m>15001</span>
</span></span></code></pre></td></tr></table></div></div><p>ç»§ç»­çœ‹ 15001 ç«¯å£çš„ listenerï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ istioctl proxy-config listeners -n demo-to simple-server-56b4d7b7d-9zkbm --port <span class=m>15001</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ADDRESS PORT  MATCH         DESTINATION
</span></span><span class=line><span class=cl>0.0.0.0 <span class=m>15001</span> ALL           PassthroughCluster
</span></span><span class=line><span class=cl>0.0.0.0 <span class=m>15001</span> Addr: *:15001 Non-HTTP/Non-TCP
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>istioctl proxy-config listeners -n demo-to simple-server-56b4d7b7d-9zkbm --port <span class=m>15001</span> -ojson
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;virtualOutbound&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;address&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;socketAddress&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;address&#34;</span>: <span class=s2>&#34;0.0.0.0&#34;</span>,
</span></span><span class=line><span class=cl>                <span class=s2>&#34;portValue&#34;</span>: <span class=m>15001</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filterChains&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>              // ...çœç•¥
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;filters&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                    <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;envoy.filters.network.tcp_proxy&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;typedConfig&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;@type&#34;</span>: <span class=s2>&#34;type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy&#34;</span>,
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;statPrefix&#34;</span>: <span class=s2>&#34;PassthroughCluster&#34;</span>,
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;cluster&#34;</span>: <span class=s2>&#34;PassthroughCluster&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>]</span>,
</span></span><span class=line><span class=cl>                <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;virtualOutbound-catchall-tcp&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;useOriginalDst&#34;</span>: true,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;transparent&#34;</span>: true,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;trafficDirection&#34;</span>: <span class=s2>&#34;OUTBOUND&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>ç»§ç»­çœ‹ envoy.filters.network.tcp_proxy å¯¹åº”çš„ PassthroughCluster Clusterï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ istioctl proxy-config cluster -n demo-to simple-server-56b4d7b7d-9zkbm  --fqdn <span class=s2>&#34;PassthroughCluster&#34;</span>  -ojson
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>  <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;PassthroughCluster&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;ORIGINAL_DST&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;connectTimeout&#34;</span>: <span class=s2>&#34;10s&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;lbPolicy&#34;</span>: <span class=s2>&#34;CLUSTER_PROVIDED&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;circuitBreakers&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;thresholds&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;maxConnections&#34;</span>: 4294967295,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;maxPendingRequests&#34;</span>: 4294967295,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;maxRequests&#34;</span>: 4294967295,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;maxRetries&#34;</span>: 4294967295,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;trackRemaining&#34;</span>: <span class=nb>true</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;typedExtensionProtocolOptions&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;@type&#34;</span>: <span class=s2>&#34;type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;useDownstreamProtocolConfig&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;httpProtocolOptions&#34;</span>: <span class=o>{}</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;http2ProtocolOptions&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;maxConcurrentStreams&#34;</span>: <span class=m>1073741824</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;filters&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;istio.metadata_exchange&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;typedConfig&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;@type&#34;</span>: <span class=s2>&#34;type.googleapis.com/udpa.type.v1.TypedStruct&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;typeUrl&#34;</span>: <span class=s2>&#34;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;value&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;protocol&#34;</span>: <span class=s2>&#34;istio-peer-exchange&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæ²¡æœ‰ä¿®æ”¹æº IPã€‚</p><h2 id=å‚è€ƒèµ„æ–™>å‚è€ƒèµ„æ–™</h2><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://istio.io/latest/zh/docs/tasks/observability/logs/access-log/>Isito Doc: è·å– Envoy è®¿é—®æ—¥å¿—</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage>Envoy Doc: Access logging</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://dev.to/aws-builders/understanding-istio-access-logs-2k5o>Understanding Istio Access Logs</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/response_code_details#response-code-details>Envoy Doc: Response Code Details</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://tetrate.io/blog/observe-service-mesh-with-skywalking-and-envoy-access-log-service>Observe Service Mesh with SkyWalking and Envoy Access Log Service</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://istio-operation-bible.aeraki.net/docs/debug-istio/envoy-log/>Istio è¿ç»´å®æˆ˜ï¼šEnvoy æ—¥å¿—è°ƒè¯•æŒ‡å—</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p><a href=https://www.bbsmax.com/A/A2dmD9l45e/>istio å¸¸è§çš„ 10 ä¸ªå¼‚å¸¸</a>&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:8><p><a href=https://github.com/istio/istio/blob/1.11.3/tools/istio-iptables/pkg/cmd/root.go>istio-iptables æºç </a>&#160;<a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:9><p><a href=https://jimmysong.io/blog/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/>ç†è§£ Istio Service Mesh ä¸­ Envoy ä»£ç† Sidecar æ³¨å…¥åŠæµé‡åŠ«æŒ</a>&#160;<a href=#fnref:9 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:9 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:10><p><a href=https://kiyonlin.github.io/post/work/iptables/iptables-2-%E6%9F%A5%E8%AF%A2%E5%91%BD%E4%BB%A4/>iptablesè¯¦è§£-æŸ¥è¯¢å‘½ä»¤</a>&#160;<a href=#fnref:10 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:11><p><a href=https://dong-dada.github.io/linux/2021/05/06/iptables.html>Linux - iptables</a>&#160;<a href=#fnref:11 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:12><p><a href=https://jimmysong.io/blog/sidecar-injection-iptables-and-traffic-routing/>Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£</a>&#160;<a href=#fnref:12 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:13><p><a href=https://help.aliyun.com/document_detail/464794.html>åœ¨æœåŠ¡ç½‘æ ¼ç¯å¢ƒä¸‹å¦‚ä½•ä¿æŒæœåŠ¡è®¿é—®æ—¶çš„å®¢æˆ·ç«¯æºIP</a>&#160;<a href=#fnref:13 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></main><script>const repo="mivinci/hugo-theme-minima",issueTerm="pathname",theme=localStorage.theme?`github-${localStorage.theme}`:"preferred-color-scheme",script=document.createElement("script");script.src="https://utteranc.es/client.js",script.async=!0,script.crossOrigin="anonymous",script.setAttribute("repo",repo),script.setAttribute("issue-term",issueTerm),script.setAttribute("theme",theme),script.setAttribute("label","comment"),document.querySelector("main").appendChild(script)</script><footer class="mt-8 flex sm:flex-col-reverse justify-between items-center"><p class="mt-0 text-sm">Â© huanggze 2021 |
<a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> on
<a href=https://github.com/mivinci/hugo-theme-minima target=_blank rel="noopener noreferrer">Minima</a></p><p class="flex items-center mt-0"><a class="icon mx-2" href=https://github.com/huanggze title=github><svg fill="#63636f" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="icon mx-2" href=/index.xml title=rss><svg fill="#63636f" t="1626591563876" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="1984" width="18" height="16"><path d="M128 768a128 128 0 100 256 128 128 0 000-256zM0 368v176c265.104.0 480 214.912 480 480h176c0-362.32-293.696-656-656-656zM0 0v176c468.336.0 848 379.664 848 848h176C1024 458.464 565.536.0.0.0z" p-id="1985"/></svg></a></p></footer></body></html>