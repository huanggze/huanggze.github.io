<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="GitLab CI å·¥ä½œåŸç†"><meta property="og:description" content="æœ¬æ–‡ä»‹ç»ï¼Œå½“æˆ‘ä»¬å‘ GitLab ä»£ç ä»“åº“æäº¤ä»£ç åï¼ˆmerge requestï¼‰ï¼ŒGitLab Server å¦‚ä½•è§¦å‘æµæ°´çº¿å’Œæ‰§è¡Œ CI Jobã€‚äº†è§£ GitLab CI å·¥ä½œåŸç†å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½å®è·µå’Œä¼˜åŒ– CI æµç¨‹ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚
æ¦‚å¿µ GitLab CI åŠŸèƒ½æ¶‰åŠä»¥ä¸‹ç»„ä»¶ï¼š
GitLab Serverï¼šGitLab åç«¯ï¼Œé€šè¿‡ REST API æä¾›å„ç§èƒ½åŠ›ï¼ŒåŒ…æ‹¬ Git ä»“åº“ç®¡ç†ã€CI/CD åŠŸèƒ½ï¼› GitLab Runnerï¼šå’Œ Jenkins çš„ agent æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œè´Ÿè´£ä» GitLab Server ä¸­ä¸æ–­åœ°æ‹¿åˆ°å¾…æ‰§è¡Œ Jobï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª Executor å»æ‰§è¡Œã€‚Runner å¯ä»¥æ˜¯äºŒè¿›åˆ¶éƒ¨ç½²ï¼Œä¹Ÿå¯ä»¥æ˜¯éƒ¨ç½²ä¸ºä¸€ä¸ª Docker å®¹å™¨ï¼Œæˆ–è€…æ˜¯ K8s é›†ç¾¤ä¸­çš„ Podï¼› GitLab Executorï¼šCI Job æ‰§è¡Œå™¨ï¼Œå®é™…å¤„ç† CI ä»»åŠ¡ã€‚GitLab æ”¯æŒå¤šç§ Executorï¼Œæ¯”å¦‚ï¼šä¸€ä¸ª CI Job å¯ä»¥åœ¨ä¸€ä¸ªæœ¬åœ°ç‰©ç†æœºä¸Šæ‰§è¡Œã€æˆ–ä¸€ä¸ªæ¯æ¬¡æ–°å»ºçš„è™šæ‹Ÿæœºç¯å¢ƒä¸­æ‰§è¡Œã€æˆ– Docker å®¹å™¨ä»¥åŠ K8s Podï¼ˆä½¿ç”¨æ—¶æ–°å»ºï¼Œç»“æŸæ—¶é”€æ¯ï¼‰ã€‚ æ¯”å¦‚ï¼Œæˆ‘çš„å¼€å‘ç¯å¢ƒé€‰å‹æ˜¯äºŒè¿›åˆ¶éƒ¨ç½² Runnerï¼Œæ¯å°æœºå™¨ä¸Šå„éƒ¨ç½²ä¸€ä¸ªï¼Œæ‰§è¡Œå™¨ Executor é‡‡ç”¨ Dockerã€‚
GitLab CI æ¶æ„ GitLab å®˜æ–¹æ–‡æ¡£æä¾›äº† GitLab CI æ¶æ„å›¾å¦‚ä¸‹1ï¼š"><meta property="og:type" content="article"><meta property="og:url" content="https://huanggze.top/posts/dive-into-gitlab-ci/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-24T22:24:19+08:00"><meta property="article:modified_time" content="2022-08-24T22:24:19+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="GitLab CI å·¥ä½œåŸç†"><meta name=twitter:description content="æœ¬æ–‡ä»‹ç»ï¼Œå½“æˆ‘ä»¬å‘ GitLab ä»£ç ä»“åº“æäº¤ä»£ç åï¼ˆmerge requestï¼‰ï¼ŒGitLab Server å¦‚ä½•è§¦å‘æµæ°´çº¿å’Œæ‰§è¡Œ CI Jobã€‚äº†è§£ GitLab CI å·¥ä½œåŸç†å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½å®è·µå’Œä¼˜åŒ– CI æµç¨‹ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚
æ¦‚å¿µ GitLab CI åŠŸèƒ½æ¶‰åŠä»¥ä¸‹ç»„ä»¶ï¼š
GitLab Serverï¼šGitLab åç«¯ï¼Œé€šè¿‡ REST API æä¾›å„ç§èƒ½åŠ›ï¼ŒåŒ…æ‹¬ Git ä»“åº“ç®¡ç†ã€CI/CD åŠŸèƒ½ï¼› GitLab Runnerï¼šå’Œ Jenkins çš„ agent æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œè´Ÿè´£ä» GitLab Server ä¸­ä¸æ–­åœ°æ‹¿åˆ°å¾…æ‰§è¡Œ Jobï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª Executor å»æ‰§è¡Œã€‚Runner å¯ä»¥æ˜¯äºŒè¿›åˆ¶éƒ¨ç½²ï¼Œä¹Ÿå¯ä»¥æ˜¯éƒ¨ç½²ä¸ºä¸€ä¸ª Docker å®¹å™¨ï¼Œæˆ–è€…æ˜¯ K8s é›†ç¾¤ä¸­çš„ Podï¼› GitLab Executorï¼šCI Job æ‰§è¡Œå™¨ï¼Œå®é™…å¤„ç† CI ä»»åŠ¡ã€‚GitLab æ”¯æŒå¤šç§ Executorï¼Œæ¯”å¦‚ï¼šä¸€ä¸ª CI Job å¯ä»¥åœ¨ä¸€ä¸ªæœ¬åœ°ç‰©ç†æœºä¸Šæ‰§è¡Œã€æˆ–ä¸€ä¸ªæ¯æ¬¡æ–°å»ºçš„è™šæ‹Ÿæœºç¯å¢ƒä¸­æ‰§è¡Œã€æˆ– Docker å®¹å™¨ä»¥åŠ K8s Podï¼ˆä½¿ç”¨æ—¶æ–°å»ºï¼Œç»“æŸæ—¶é”€æ¯ï¼‰ã€‚ æ¯”å¦‚ï¼Œæˆ‘çš„å¼€å‘ç¯å¢ƒé€‰å‹æ˜¯äºŒè¿›åˆ¶éƒ¨ç½² Runnerï¼Œæ¯å°æœºå™¨ä¸Šå„éƒ¨ç½²ä¸€ä¸ªï¼Œæ‰§è¡Œå™¨ Executor é‡‡ç”¨ Dockerã€‚
GitLab CI æ¶æ„ GitLab å®˜æ–¹æ–‡æ¡£æä¾›äº† GitLab CI æ¶æ„å›¾å¦‚ä¸‹1ï¼š"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#262d33"><title>Hi Folks - GitLab CI å·¥ä½œåŸç†</title><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel=stylesheet><link rel=stylesheet href=/minima.1671354978.css><script defer type=text/javascript src=/minima.1671354978.js></script></head><script>try{"theme"in localStorage||(localStorage.theme=window.matchMedia("(prefer-color-scheme: dark)").matches?"dark":"light"),document.querySelector("html").classList.add(localStorage.theme)}catch(e){console.error(e)}</script><body class="sm:mx-5 sm:my-0"><header class="flex justify-between items-center mb-6 sm:my-3"><div class="flex items-center"><div id=theme-switcher class="text-4xl cursor-pointer">ğŸŒ</div></div><nav class="flex items-center
whitespace-nowrap overflow-x-auto overflow-y-hidden"><a class=ml-5 href=/>Home</a>
<a class=ml-5 href=/categories>Categories</a>
<a class=ml-5 href=/series>Series</a>
<a class=ml-5 href=/about>About</a></nav></header><h1 class="mt-6 mb-6">GitLab CI å·¥ä½œåŸç†</h1><div class="mb-3 text-xs flex justify-between sm:flex-col"><div>Posted at &mdash; Aug 24, 2022</div></div><main><p></p><article class=md><p>æœ¬æ–‡ä»‹ç»ï¼Œå½“æˆ‘ä»¬å‘ GitLab ä»£ç ä»“åº“æäº¤ä»£ç åï¼ˆmerge requestï¼‰ï¼ŒGitLab Server å¦‚ä½•è§¦å‘æµæ°´çº¿å’Œæ‰§è¡Œ CI Jobã€‚äº†è§£ GitLab CI å·¥ä½œåŸç†å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½å®è·µå’Œä¼˜åŒ– CI æµç¨‹ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚</p><h1 id=æ¦‚å¿µ>æ¦‚å¿µ</h1><p>GitLab CI åŠŸèƒ½æ¶‰åŠä»¥ä¸‹ç»„ä»¶ï¼š</p><ul><li>GitLab Serverï¼šGitLab åç«¯ï¼Œé€šè¿‡ REST API æä¾›å„ç§èƒ½åŠ›ï¼ŒåŒ…æ‹¬ Git ä»“åº“ç®¡ç†ã€CI/CD åŠŸèƒ½ï¼›</li><li>GitLab Runnerï¼šå’Œ Jenkins çš„ agent æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œè´Ÿè´£ä» GitLab Server ä¸­ä¸æ–­åœ°æ‹¿åˆ°å¾…æ‰§è¡Œ Jobï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª Executor å»æ‰§è¡Œã€‚Runner å¯ä»¥æ˜¯äºŒè¿›åˆ¶éƒ¨ç½²ï¼Œä¹Ÿå¯ä»¥æ˜¯éƒ¨ç½²ä¸ºä¸€ä¸ª Docker å®¹å™¨ï¼Œæˆ–è€…æ˜¯ K8s é›†ç¾¤ä¸­çš„ Podï¼›</li><li>GitLab Executorï¼šCI Job æ‰§è¡Œå™¨ï¼Œå®é™…å¤„ç† CI ä»»åŠ¡ã€‚GitLab æ”¯æŒå¤šç§ Executorï¼Œæ¯”å¦‚ï¼šä¸€ä¸ª CI Job å¯ä»¥åœ¨ä¸€ä¸ªæœ¬åœ°ç‰©ç†æœºä¸Šæ‰§è¡Œã€æˆ–ä¸€ä¸ªæ¯æ¬¡æ–°å»ºçš„è™šæ‹Ÿæœºç¯å¢ƒä¸­æ‰§è¡Œã€æˆ– Docker å®¹å™¨ä»¥åŠ K8s Podï¼ˆä½¿ç”¨æ—¶æ–°å»ºï¼Œç»“æŸæ—¶é”€æ¯ï¼‰ã€‚</li></ul><p>æ¯”å¦‚ï¼Œæˆ‘çš„å¼€å‘ç¯å¢ƒé€‰å‹æ˜¯äºŒè¿›åˆ¶éƒ¨ç½² Runnerï¼Œæ¯å°æœºå™¨ä¸Šå„éƒ¨ç½²ä¸€ä¸ªï¼Œæ‰§è¡Œå™¨ Executor é‡‡ç”¨ Dockerã€‚</p><h1 id=gitlab-ci-æ¶æ„>GitLab CI æ¶æ„</h1><p>GitLab å®˜æ–¹æ–‡æ¡£æä¾›äº† GitLab CI æ¶æ„å›¾å¦‚ä¸‹<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>ï¼š</p><p><img src=/images/gitlab_ci_architecture.png alt></p><p>ä»å·¦åˆ°å³ï¼š</p><ol><li>è§¦å‘ Pipeline</li></ol><p>GitLab CI åŠŸèƒ½ä»æµæ°´çº¿è§¦å‘äº‹ä»¶å¼€å§‹ã€‚æµæ°´çº¿è§¦å‘æœ‰å¤šç§æ–¹å¼ï¼Œæœ€å¸¸è§çš„æ˜¯ <code>git push</code>ã€åœ¨ UI ä¸Šç‚¹å‡» &ldquo;Run pipeline"æŒ‰é’®ã€æäº¤ MR æˆ–è€…è°ƒç”¨ Pipeline API è§¦å‘ç­‰ã€‚ä»»ä½•è§¦å‘äº‹ä»¶éƒ½ä¼šè°ƒç”¨ <a href=https://gitlab.com/gitlab-org/gitlab/-/blob/master/app/services/ci/create_pipeline_service.rb>CreatePipelineService</a> æ¨¡å—ã€‚</p><p>GitLab Server ä¸­çš„ CreatePipelineService æ¨¡å—è´Ÿè´£æ¥æ”¶æµæ°´çº¿è§¦å‘äº‹ä»¶ï¼Œå¹¶ä¾é  <a href=https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/yaml_processor.rb>YAML Processor ç»„ä»¶</a> åˆ›å»ºæµæ°´çº¿ã€‚YAML Processor è¯»å–å¹¶è§£æç”¨æˆ·ç¼–å†™çš„ .gitlab-ci.yml æ–‡ä»¶ï¼Œå¹¶è½¬åŒ–æˆä¸€ä¸ªåŒ…å«æµæ°´çº¿ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰ã€‚</p><ol start=2><li>Pipeline å¤„ç†</li></ol><p>å½“æµæ°´çº¿åˆ›å»ºå¥½åï¼Œæµæ°´çº¿ä¸­çš„æ¯ä¸ª Job çš„çŠ¶æ€<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>ç”± <a href=https://gitlab.com/gitlab-org/gitlab/-/blob/master/app/services/ci/process_pipeline_service.rb>ProcessPipelineService</a> æ¨¡å—ç®¡ç†å’Œè¿½è¸ªã€‚æœ€å¼€å§‹ï¼ŒJob çš„çŠ¶æ€éƒ½æ˜¯ createdã€‚ProcessPipelineService å°†å¯ä»¥å¼€å§‹æ‰§è¡Œçš„ Job çŠ¶æ€æ ‡è®°ä¸º pendingã€‚</p><p>å¤„äº pending çŠ¶æ€ Job å¯ä»¥è¢« GitLab Runner æ‹¿åˆ°å¹¶æ‰§è¡Œï¼Œè¿›å…¥åˆ° running çŠ¶æ€ã€‚æœ€ç»ˆï¼Œæ‰§è¡Œå®Œçš„ Job çŠ¶æ€ä» Runner è¿”å›ç»™ GitLab Serverï¼Œå¹¶ç”± ProcessPipelineService ä¿®æ”¹çŠ¶æ€ä¸º success æˆ– failedã€‚</p><ol start=3><li>åˆ†é… Job åˆ° Runner</li></ol><p>CI Job åˆ†é…æ˜¯ç”± Runner ä¸»åŠ¨å‘èµ·ã€‚å½“ GitLab Server æ”¶åˆ° Runner çš„è¯·æ±‚ï¼ˆå¦‚ä¸‹å›¾<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>ï¼‰ï¼Œä¼šé€šè¿‡ <a href=https://gitlab.com/gitlab-org/gitlab/-/blob/master/app/services/ci/register_job_service.rb>RegisterJobService</a> æ¨¡å—é€‰æ‹©å¹¶è¿”å›ä¸€ä¸ª pending Job ç»™ Runnerã€‚å½“å½“å‰æ‰€æœ‰ Job å…¨éƒ¨æ‰§è¡Œå®Œï¼ŒGitLab Server ä¼šå°†ä¸‹ä¸€ä¸ªé˜¶æ®µï¼ˆstageï¼‰çš„ CI Job çŠ¶æ€æ”¹ä¸º pending å¾…æ‰§è¡Œã€‚</p><p><img src=/images/gitlab_runner_request_job.png alt></p><h1 id=gitlab-runner-å·¥ä½œåŸç†>GitLab Runner å·¥ä½œåŸç†</h1><h2 id=å®‰è£…å¯åŠ¨æ³¨å†Œ-runner>å®‰è£…ã€å¯åŠ¨ã€æ³¨å†Œ Runner</h2><p>å¸¸è§ Runner å®‰è£…æ–¹å¼æœ‰ä¸‰ç§ï¼š</p><ul><li>äºŒè¿›åˆ¶</li><li>Dockerï¼šå®‰è£…ã€å¯åŠ¨å’Œæ³¨å†Œçš„æµç¨‹åŒäºŒè¿›åˆ¶</li><li>K8sï¼šéœ€è¦ K8s é›†ç¾¤ï¼Œå¯ç”¨ Helm Chart ä¸€é”®å®‰è£…éƒ¨ç½² Runnerã€‚æ³¨å†Œç­‰å‚æ•°å†™åœ¨ Chart çš„é…ç½®é‡Œ</li></ul><p>GitLab Runner å®‰è£…å¥½åï¼Œåªæœ‰å…ˆæ³¨å†Œã€ç»‘å®šåˆ° GitLab Serverï¼Œæ‰èƒ½æ­£å¸¸å’Œ GitLab Server é€šä¿¡ã€å·¥ä½œã€‚å®‰è£…å’Œæ³¨å†Œ Runner å¯ä»¥é€šè¿‡ gitlab-runner CLI å‘½ä»¤å®Œæˆ<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># æŒ‡å®šç”¨æˆ·åã€å·¥ä½œç›®å½•å®‰è£… gitlab-runner æœåŠ¡</span>
</span></span><span class=line><span class=cl>gitlab-runner install --user<span class=o>=</span>gitlab-runner --working-directory<span class=o>=</span>/home/gitlab-runner
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¯åŠ¨ gitlab-runner æœåŠ¡</span>
</span></span><span class=line><span class=cl>gitlab-runner start
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æŒ‰æç¤ºå‘ GitLab Server æ³¨å†Œè‡ªå·±ã€ä»¥åŠè®¾ç½® tag</span>
</span></span><span class=line><span class=cl>gitlab-runner register
</span></span></code></pre></td></tr></table></div></div><h2 id=executor-é€‰å‹>Executor é€‰å‹</h2><p>Runner åˆ›å»ºå¤šä¸ª Executor æ‰§è¡Œä¸åŒ CI Jobï¼ŒExecutor æ˜¯ CI Job çœŸæ­£æ‰§è¡Œç¯å¢ƒï¼Œæ‰§è¡Œç¯å¢ƒäº’ç›¸éš”ç¦»ã€‚GitLab æ”¯æŒä»¥ä¸‹å‡ ç§ Executor é€‰é¡¹<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>ï¼š</p><ul><li>Shellï¼šå³ Runner ç›´æ¥åœ¨è‡ªå·±çš„æœ¬åœ°æœºå™¨ä¸Šæ‰§è¡Œ CI Jobï¼Œå› æ­¤å¦‚æœ CI Job è¦æ‰§è¡Œå„ç§æŒ‡ä»¤ï¼Œä¾‹å¦‚ makeã€dockerã€flake8&mldr;ï¼Œéœ€è¦æå‰å®‰è£…å¥½è¿™äº›å‘½ä»¤è¡Œå·¥å…·ï¼›</li><li>VirtualBoxï¼šæ¯æ¬¡è¦æ‰§è¡Œï¼Œä¼šå»ºç«‹ä¸€ä¸ªå¹²å‡€çš„ VMï¼Œé€è¿‡ SSH ç™»å½•æ­¤ VMï¼Œå¹¶åœ¨å…¶ä¸­æ‰§è¡Œ CI Jobï¼›</li><li>Dockerï¼šåŒä¸Šï¼Œä½†é€è¿‡ Docker æ‰§è¡Œ Jobã€‚Runner è¿æ¥åˆ° Docker Engineï¼Œè¯·æ±‚ Docker Engine åˆ›å»ºå®¹å™¨æ‰§è¡Œ Jobã€‚Docker Executor çš„ç›¸å…³çš„å‚æ•°å†™åœ¨ Runner çš„é…ç½®æ–‡ä»¶ config.toml ä¸­çš„ [ runner.docker ] ä¸‹é¢ï¼ŒåŒ…å«é•œåƒæ‹‰å–ç­–ç•¥ï¼ˆpull-policyï¼‰ç­‰å‚æ•°ï¼›</li><li>Kubernetesï¼šåŒ Docker ä¸€æ ·ï¼Œä¹Ÿæ˜¯åœ¨å®¹å™¨ç¯å¢ƒä¸­æ‰§è¡Œ Jobã€‚ä½† Runner æ“æ§çš„ä¸å†æ˜¯ Docker Engineï¼Œè€Œæ˜¯ K8sã€‚Runner è¿æ¥åˆ° K8s API Serverï¼Œæ¯å½“æœ‰ CI Job æŒ‡æ´¾ç»™ Runner æ—¶ï¼ŒRunner å°±ä¼šé€è¿‡ K8s å…ˆå»ºç«‹ä¸€ä¸ªå¹²å‡€çš„ Podï¼Œæ¥ç€åœ¨å…¶ä¸­æ‰§è¡Œ CI Jobã€‚</li></ul><h2 id=æ—¶åºå›¾6>æ—¶åºå›¾<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup></h2><p><img src=/images/gitlab_ci_runner_workflow.png alt></p><p>Runner çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ¯ä¸ªç©ºé—²çš„ Runner ä¼šæŒç»­ã€å‘¨æœŸæ€§åœ°è°ƒç”¨ POST /api/v4/jobs/request APIï¼ˆé»˜è®¤æ¯ 3 ç§’ï¼‰ï¼Œå‘ GitLab Server è¯·æ±‚æ’é˜Ÿä¸­å¾…æ‰§è¡Œçš„ CI Jobã€‚å¤§å¤šæ•°æ—¶å€™ï¼ŒServer è¿”å› 204ï¼ˆNo Contentï¼‰ã€‚</li></ol><p>å½“æœ‰ commit æäº¤æ—¶ï¼ŒGitLab Server æ£€æŸ¥ commit ä¸­çš„ .gitlab-ci.yaml æ–‡ä»¶è§¦å‘ CI/CD æµæ°´çº¿ï¼Œäº§ç”Ÿ pipeline å’Œ CI Jobã€‚Runner å†è¯·æ±‚ API æ—¶ï¼Œä¼šè¿”å› 201ï¼ˆCreatedï¼‰ï¼Œä»¥åŠ Job ä¿¡æ¯ã€‚å…·ä½“è¿”å›å“ªä¸ª Job ç»™ Runnerï¼Œç”± Server æ ¹æ®ä¸€å®šçš„ç­–ç•¥å†³å®šï¼Œå¦‚ï¼šè°å…ˆè¯·æ±‚ï¼Œå…ˆåˆ†é…ç»™è°ã€‚</p><ol start=2><li><p>Runner æ”¶åˆ°åˆ†é…çš„ Job åï¼Œè°ƒç”¨ PUT /api/v4/jobs/{job_id} ç¡®è®¤ï¼Œå¹¶åˆ›å»º Executor å»å®é™…æ‰§è¡Œ Jobã€‚æ¯”å¦‚ä½¿ç”¨çš„ Executor æ˜¯ Dockerï¼ŒJob å°±ä»¥ docker-in-docker çš„æ–¹å¼æ‰§è¡Œã€‚</p></li><li><p>Executor æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸­é—´ç»“æœå’Œä¿¡æ¯ï¼Œä¼šè¿”å›ç»™ Runnerã€‚Runner åˆ™è°ƒç”¨ PATCH /api/v4/jobs/{job_id}/trace API å°†ä¸­é—´çŠ¶æ€ä¿¡æ¯ã€æ—¥å¿—å†™å› Serverã€‚å½“æœ€ç»ˆæ‰§è¡Œå®Œæˆï¼Œè°ƒç”¨ PUT /api/v4/jobs/{job_id} æ›´æ–° Job ç»“æœã€‚</p></li></ol><p><img src=/images/gitlab_ci_runner_api_1.png alt></p><p><img src=/images/gitlab_ci_runner_api_2.png alt></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://docs.gitlab.com/ee/development/cicd/>CI Architecture overview</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://docs.gitlab.com/ee/ci/jobs/#the-order-of-jobs-in-a-pipeline>CI Job Status</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://opentalk-blog.b0.upaiyun.com/prod/2017-10-27/59c1c82f33c56c23422250ca45f52d31.pdf>â¼œæ‹äº‘ CI/CD å®è·µ</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://docs.gitlab.com/runner/commands/>GitLab Runner commands</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://chengweichen.com/2021/03/gitlab-ci-executor.html>GitLab CI ä¹‹ Runner çš„ Executor è©²å¦‚ä½•é¸æ“‡ï¼Ÿ</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://docs.gitlab.com/runner/#runner-execution-flow>Runner execution flow</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></main><script>const repo="mivinci/hugo-theme-minima",issueTerm="pathname",theme=localStorage.theme?`github-${localStorage.theme}`:"preferred-color-scheme",script=document.createElement("script");script.src="https://utteranc.es/client.js",script.async=!0,script.crossOrigin="anonymous",script.setAttribute("repo",repo),script.setAttribute("issue-term",issueTerm),script.setAttribute("theme",theme),script.setAttribute("label","comment"),document.querySelector("main").appendChild(script)</script><footer class="mt-8 flex sm:flex-col-reverse justify-between items-center"><p class="mt-0 text-sm">Â© huanggze 2021 |
<a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> on
<a href=https://github.com/mivinci/hugo-theme-minima target=_blank rel="noopener noreferrer">Minima</a></p><p class="flex items-center mt-0"><a class="icon mx-2" href=https://github.com/huanggze title=github><svg fill="#63636f" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="icon mx-2" href=/index.xml title=rss><svg fill="#63636f" t="1626591563876" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="1984" width="18" height="16"><path d="M128 768a128 128 0 100 256 128 128 0 000-256zM0 368v176c265.104.0 480 214.912 480 480h176c0-362.32-293.696-656-656-656zM0 0v176c468.336.0 848 379.664 848 848h176C1024 458.464 565.536.0.0.0z" p-id="1985"/></svg></a></p></footer></body></html>