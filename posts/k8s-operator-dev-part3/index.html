<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="K8s Operator å¼€å‘ï¼ˆä¸‰ï¼‰ï¼šCache æœºåˆ¶">
<meta property="og:description" content="Cache ä¸Šä¸€ç¯‡è°ˆåˆ° Kubebuilder ä½¿ç”¨çš„æ˜¯è¯»å†™åˆ†ç¦»çš„å®¢æˆ·ç«¯ã€‚è¯»å®¢æˆ·ç«¯é‡‡ç”¨äº† Cache è®¾è®¡ã€‚é€šè¿‡æ·±å…¥è¿½è¸ª main.go çš„ ctrl.NewManager ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Kubebuilder ä½¿ç”¨ cotroller-runtime åŒ…æ„é€ å¹¶æŒæœ‰äº†ä¸€ä¸ª Cache æ¥å£å®ä¾‹ã€‚Cache æ¥å£åŒ…å«ä¸¤ä¸ªç»„ä»¶ï¼šReader å’Œ Informersã€‚è€Œ Informers æœ¬èº«å†…åµŒäº† FieldIndexer æ¥å£ã€‚
1 2 3 4 5 6 7 8 9 10  // Cache knows how to load Kubernetes objects, fetch informers to request // to receive events for Kubernetes objects (at a low-level), // and add indices to fields on the objects stored in the cache. type Cache interface { // Cache acts as a client to objects stored in the cache.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://huanggze.github.io/posts/k8s-operator-dev-part3/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-01-19T17:45:22+08:00">
<meta property="article:modified_time" content="2022-01-19T17:45:22+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="K8s Operator å¼€å‘ï¼ˆä¸‰ï¼‰ï¼šCache æœºåˆ¶">
<meta name=twitter:description content="Cache ä¸Šä¸€ç¯‡è°ˆåˆ° Kubebuilder ä½¿ç”¨çš„æ˜¯è¯»å†™åˆ†ç¦»çš„å®¢æˆ·ç«¯ã€‚è¯»å®¢æˆ·ç«¯é‡‡ç”¨äº† Cache è®¾è®¡ã€‚é€šè¿‡æ·±å…¥è¿½è¸ª main.go çš„ ctrl.NewManager ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Kubebuilder ä½¿ç”¨ cotroller-runtime åŒ…æ„é€ å¹¶æŒæœ‰äº†ä¸€ä¸ª Cache æ¥å£å®ä¾‹ã€‚Cache æ¥å£åŒ…å«ä¸¤ä¸ªç»„ä»¶ï¼šReader å’Œ Informersã€‚è€Œ Informers æœ¬èº«å†…åµŒäº† FieldIndexer æ¥å£ã€‚
1 2 3 4 5 6 7 8 9 10  // Cache knows how to load Kubernetes objects, fetch informers to request // to receive events for Kubernetes objects (at a low-level), // and add indices to fields on the objects stored in the cache. type Cache interface { // Cache acts as a client to objects stored in the cache.">
<meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff">
<meta name=theme-color media="(prefers-color-scheme: dark)" content="#262d33">
<title>
Hi Folks - K8s Operator å¼€å‘ï¼ˆä¸‰ï¼‰ï¼šCache æœºåˆ¶
</title>
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel=stylesheet>
<link rel=stylesheet href=/minima.1643985513.css>
<script defer type=text/javascript src=/minima.1643985513.js></script>
</head>
<script>try{'theme'in localStorage||(localStorage.theme=window.matchMedia('(prefer-color-scheme: dark)').matches?'dark':'light'),document.querySelector('html').classList.add(localStorage.theme)}catch(a){console.error(a)}</script>
<body class="sm:mx-5 sm:my-0">
<header class="flex justify-between items-center mb-6 sm:my-3">
<div class="flex items-center">
<div id=theme-switcher class="text-4xl cursor-pointer">ğŸŒ</div>
</div>
<nav class="flex items-center
whitespace-nowrap overflow-x-auto overflow-y-hidden">
<a class=ml-5 href=/>Home</a>
<a class=ml-5 href=/categories>Categories</a>
<a class=ml-5 href=/series>Series</a>
<a class=ml-5 href=/about>About</a>
</nav>
</header>
<details class="toc toc-lines">
<summary></summary>
<div class=pb-1>
<nav id=TableOfContents>
<ul>
<li><a href=#cache>Cache</a></li>
<li><a href=#indexer>Indexer</a>
<ul>
<li><a href=#indexers>Indexers</a></li>
<li><a href=#indices>Indices</a></li>
<li><a href=#items>Items</a></li>
<li><a href=#ç¼“å­˜åŒæ­¥>ç¼“å­˜åŒæ­¥</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</details>
<h1 class="mt-6 mb-6">K8s Operator å¼€å‘ï¼ˆä¸‰ï¼‰ï¼šCache æœºåˆ¶</h1>
<div class="mb-3 text-xs flex justify-between sm:flex-col">
<div>
Posted at &mdash; Jan 19, 2022
</div>
</div>
<main>
<p></p>
<article class=md>
<h2 id=cache>Cache</h2>
<p>ä¸Šä¸€ç¯‡è°ˆåˆ° Kubebuilder ä½¿ç”¨çš„æ˜¯è¯»å†™åˆ†ç¦»çš„å®¢æˆ·ç«¯ã€‚è¯»å®¢æˆ·ç«¯é‡‡ç”¨äº† Cache è®¾è®¡ã€‚é€šè¿‡æ·±å…¥è¿½è¸ª main.go çš„ ctrl.NewManager ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Kubebuilder ä½¿ç”¨ cotroller-runtime åŒ…æ„é€ å¹¶æŒæœ‰äº†ä¸€ä¸ª <a href=https://github.com/kubernetes-sigs/controller-runtime/blob/v0.11.0/pkg/cache/cache.go#L136>Cache æ¥å£å®ä¾‹</a>ã€‚Cache æ¥å£åŒ…å«ä¸¤ä¸ªç»„ä»¶ï¼šReader å’Œ Informersã€‚è€Œ Informers æœ¬èº«å†…åµŒäº† FieldIndexer æ¥å£ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Cache knows how to load Kubernetes objects, fetch informers to request
</span><span class=c1>// to receive events for Kubernetes objects (at a low-level),
</span><span class=c1>// and add indices to fields on the objects stored in the cache.
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Cache</span> <span class=kd>interface</span> <span class=p>{</span>
	<span class=c1>// Cache acts as a client to objects stored in the cache.
</span><span class=c1></span>	<span class=nx>client</span><span class=p>.</span><span class=nx>Reader</span>

	<span class=c1>// Cache loads informers and adds field indices.
</span><span class=c1></span>	<span class=nx>Informers</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ‰€ä»¥ï¼ŒCache ä¸€å…±æä¾›æ–¹æ³•å¦‚ä¸‹ã€‚Reader æ¥å£å¾ˆç®€å•ï¼Œæä¾› Get å’Œ List æ–¹æ³•ã€‚Infomers æ˜¯æ–°æ¦‚å¿µï¼ŒInformers ä¿æŒçš„æ˜¯ä¸€ç»„ Informerã€‚Cache å¯¹è±¡å¯ä»¥é€šè¿‡ GetInformer/GetInformerForKind æ–¹æ³•è·å¾—ã€‚Start ç”¨äº Informers çš„åˆå§‹åŒ–å’Œå¯åŠ¨ã€‚WaitForCacheSync ç­‰å¾…ç¼“å­˜åŒæ­¥å®Œæˆã€‚</p>
<ol>
<li>Get(ctx context.Context, key ObjectKey, obj Object) error</li>
<li>List(ctx context.Context, list ObjectList, opts &mldr;ListOption) error</li>
<li>GetInformer(ctx context.Context, obj client.Object) (Informer, error)</li>
<li>GetInformerForKind(ctx context.Context, gvk schema.GroupVersionKind) (Informer, error)</li>
<li>Start(ctx context.Context) error</li>
<li>WaitForCacheSync(ctx context.Context) bool</li>
<li>IndexField(ctx context.Context, obj Object, field string, extractValue IndexerFunc) error</li>
</ol>
<blockquote>
<p>Informer çš„å¯åŠ¨ï¼š<br>
å®é™…ä¸Šè°ƒç”¨ Start()ï¼ˆè¿è¡Œåœ¨ä¸€ä¸ª <a href=https://github.com/kubernetes-sigs/controller-runtime/blob/v0.10.0/pkg/manager/internal.go#L696>Runnable</a> åå° goroutine ä¸­ï¼‰ä¸ä¼šçœŸæ­£æŠŠå„ä¸ª informer è·‘èµ·æ¥ï¼Œå³<a href=https://github.com/kubernetes-sigs/controller-runtime/blob/v0.10.0/pkg/cache/internal/informers_map.go#L150-L152>æºç </a>ä¸­ for å¾ªç¯ <code>go informer.Informer.Run(ctx.Done())</code> ä¸ä¼šè¿›å…¥ï¼Œå› ä¸ºæ­¤æ—¶ informersByGVK å†…å®¹ä¸ºç©ºã€‚çœŸæ­£ Informer.Run() æ˜¯åœ¨ <a href=https://github.com/kubernetes-sigs/controller-runtime/blob/v0.10.0/pkg/source/source.go#L123>GetInformer()</a> ï¼ˆä»¥åŠ Get/List/GetInformerForKindï¼‰æ—¶ï¼Œåº•å±‚è°ƒç”¨ <a href=https://github.com/kubernetes-sigs/controller-runtime/blob/v0.10.0/pkg/cache/internal/informers_map.go#L194>addInformerToMap()</a> æ–¹æ³•å»¶è¿Ÿè¿è¡Œã€‚</p>
</blockquote>
<p>å‰é¢æåˆ° Informers ä¿æŒçš„æ˜¯ä¸€ç»„ Informerã€‚æ¯ä¸ª Informer å®Œæˆä¸¤ä¸ªå·¥ä½œï¼š1. ç›‘å¬ä¸€ç§ K8s èµ„æºçš„çŠ¶æ€ï¼›2. æŠŠçŠ¶æ€ä¿å­˜åˆ°ç¼“å­˜ï¼ˆin-memory cacheï¼‰ä¸­ã€‚èµ„æºç›‘å¬æ˜¯é€šè¿‡ ListAndWatch æœºåˆ¶æ‹¿åˆ°èµ„æºçš„æœ€æ–°çŠ¶æ€ï¼Œè€Œä¸æ˜¯è½®è®­ kube-apiserverã€‚åè€…ï¼ŒK8s èµ„æºå’Œ Informer çš„ç¼“å­˜é€šè¿‡ map æ˜ å°„ï¼Œ<a href=https://github.com/kubernetes-sigs/controller-runtime/blob/v0.11.0/pkg/cache/internal/informers_map.go#L97>ä»¥ GVK ä½œä¸º map çš„ key</a>ï¼Œä¿å­˜åœ¨ specificInformersMapï¼ˆInformer çš„åº•å±‚å®ç°ï¼‰çš„ informersByGVK å­—æ®µã€‚è·å–ä¸€ä¸ªå…·ä½“çš„ Informer ç¼“å­˜å¯ä»¥é€šè¿‡ Informers çš„ GetInformerForKind() æ–¹æ³•ï¼Œåº•å±‚ä¼šè°ƒç”¨ specificInformersMap å®ç°çš„ <a href=(https://github.com/kubernetes-sigs/controller-runtime/blob/v0.11.0/pkg/cache/internal/informers_map.go#L184)>Get()</a> è·å–ã€‚Get æ–¹æ³•è¿”å›ä¸€ä¸ª *MapEntry å¼•ç”¨å¯¹è±¡ã€‚MapEntry å°è£…äº†ä¸€ä¸ª client-go åº“çš„ cache åŒ…ä¸‹çš„ SharedIndexInformer æ¥å£å’Œä¸€ä¸ª CacheReader ç»“æ„ä½“ï¼ˆReader çš„æ¥å£å®ç°ï¼‰ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>MapEntry</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=c1>// Informer is the cached informer
</span><span class=c1></span>	<span class=nx>Informer</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>SharedIndexInformer</span>

	<span class=c1>// CacheReader wraps Informer and implements the CacheReader interface for a single type
</span><span class=c1></span>	<span class=nx>Reader</span> <span class=nx>CacheReader</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ä¸ºä»€ä¹ˆ MapEntry ä¸¤ä¸ªå­—æ®µä¸€ä¸ªæ˜¯æ¥å£ç±»å‹ï¼Œä¸€ä¸ªæ˜¯ç»“æ„ä½“ç±»å‹ï¼Ÿ<br>
cache.SharedIndexInformer çš„æ¥å£å®ç°éƒ½åŒ…å†…è®¿é—®ï¼ˆé¦–å­—æ¯æ˜¯å°å†™çš„ç»“æ„ä½“ï¼‰ï¼Œæ‰€ä»¥åªèƒ½ç”¨æ¥å£ç±»å‹æ¥å£°æ˜ï¼›è€Œèƒ½ç›´æ¥ä½¿ç”¨ CacheReader ç»“æ„ä½“çš„ï¼Œå°½é‡é€‰æ‹©ç»“æ„ä½“ç±»å‹å£°æ˜ï¼Œè€Œä¸ç”¨ Reader æ¥å£ï¼Œé¿å…ä¸å¿…è¦çš„åå°„ä¸”ç±»å‹å®‰å…¨ã€‚</p>
</blockquote>
<p>ç”±äºå‰é¢æåˆ°çš„æ‡’åŠ è½½ï¼ŒMapEntry çš„åˆå§‹åŒ–åœ¨ GetInformer æ—¶è°ƒç”¨ addInformerToMap() æ‰å®Œæˆã€‚å¯ä»¥çœ‹åˆ° MapEntry çš„ä¸¤ä¸ªå­—æ®µ Informer å’Œ Reader å…±äº«ä¸€ä¸ª Indexerã€‚Indexer å®é™…ä¸Šæ˜¯å¸¦ç´¢å¼•çš„ç¼“å­˜ã€‚æ­¤å¤„ <strong>Indexer æ­£æ˜¯æœ¬èŠ‚è¦è®¨è®ºçš„æ‰€è°“ Cache</strong>ï¼ˆç»ˆäºå®šä½åˆ°æ­£ç¡®çš„æºç äº†ï¼‰ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>ip</span> <span class=o>*</span><span class=nx>specificInformersMap</span><span class=p>)</span> <span class=nf>addInformerToMap</span><span class=p>(</span><span class=nx>gvk</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionKind</span><span class=p>,</span> <span class=nx>obj</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>MapEntry</span><span class=p>,</span> <span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=c1>//...
</span><span class=c1></span>	<span class=c1>// åˆ›å»ºçš„ SharedIndexInformer å¸¦æœ‰ä¸€ä¸ª Indexer
</span><span class=c1></span>	<span class=c1>// Indexer å¯é€šè¿‡ SharedIndexInformer çš„ GetIndexer æ–¹æ³•è¿”å›
</span><span class=c1></span>	<span class=nx>ni</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>NewSharedIndexInformer</span><span class=p>(</span><span class=nx>lw</span><span class=p>,</span> <span class=nx>obj</span><span class=p>,</span> <span class=nf>resyncPeriod</span><span class=p>(</span><span class=nx>ip</span><span class=p>.</span><span class=nx>resync</span><span class=p>)(),</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>Indexers</span><span class=p>{</span>
        <span class=nx>cache</span><span class=p>.</span><span class=nx>NamespaceIndex</span><span class=p>:</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>MetaNamespaceIndexFunc</span><span class=p>,</span>
    <span class=p>})</span>
	<span class=c1>// ...
</span><span class=c1></span>	
    <span class=nx>i</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>MapEntry</span><span class=p>{</span>
        <span class=nx>Informer</span><span class=p>:</span> <span class=nx>ni</span><span class=p>,</span>
        <span class=nx>Reader</span><span class=p>:</span> <span class=nx>CacheReader</span><span class=p>{</span>
            <span class=nx>indexer</span><span class=p>:</span>          <span class=nx>ni</span><span class=p>.</span><span class=nf>GetIndexer</span><span class=p>(),</span>  <span class=c1>// å…±äº« Indexer
</span><span class=c1></span>            <span class=nx>groupVersionKind</span><span class=p>:</span> <span class=nx>gvk</span><span class=p>,</span>
            <span class=nx>scopeName</span><span class=p>:</span>        <span class=nx>rm</span><span class=p>.</span><span class=nx>Scope</span><span class=p>.</span><span class=nf>Name</span><span class=p>(),</span>
            <span class=nx>disableDeepCopy</span><span class=p>:</span>  <span class=nx>ip</span><span class=p>.</span><span class=nx>disableDeepCopy</span><span class=p>.</span><span class=nf>IsDisabled</span><span class=p>(</span><span class=nx>gvk</span><span class=p>),</span>
        <span class=p>},</span>
    <span class=p>}</span>
    <span class=nx>ip</span><span class=p>.</span><span class=nx>informersByGVK</span><span class=p>[</span><span class=nx>gvk</span><span class=p>]</span> <span class=p>=</span> <span class=nx>i</span>
	
	<span class=c1>//...
</span><span class=c1></span><span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>è™½ç„¶æœ¬ç¯‡é‡ç‚¹è®² Cache å®ç°ä»¥åŠ Indexerï¼Œè¿˜æœªå…¨é¢ä»‹ç» Informerï¼ˆCache æ˜¯ Informer çš„ç»„ä»¶ï¼‰ï¼Œä½†æˆ‘ä»¬åœ¨é˜…è¯» controller-runtime æºç æ—¶ä¼šçœ‹åˆ° Informer æ¥å£æœ‰ä¸¤å¤„å®šä¹‰ï¼šcontroller-runtime åº“ä¸ä»…è‡ªèº«å®šä¹‰äº† <a href=https://github.com/kubernetes-sigs/controller-runtime/blob/v0.10.0/pkg/cache/cache.go#L73>Informer æ¥å£</a>ï¼Œè¿˜æœ‰ä¸€å¤„å¼•ç”¨äº† k8s.io/client-go/tools/cache åŒ…çš„ SharedIndexInformer æ¥å£ï¼Œå³ MapEntry çš„ Informer å­—æ®µã€‚ä¸ºä»€ä¹ˆ client-go åº“å’Œ controller-runtime åº“éƒ½å®šä¹‰ Informer æ¥å£ï¼ˆclient-go åº“ç§°ä¸º Informerï¼Œcontroller-runtime åº“ç§°ä¸º SharedIndexInformerï¼‰ï¼Ÿè¿™ä¸¤ä¸ªåº“çš„åŒºåˆ«ä¸å…³ç³»æ˜¯ï¼šcontroller-runtime åº“æ˜¯ kubebuilder æ¡†æ¶çš„åŸºç¡€ã€‚controller-runtime æä¾›äº†å¾ˆå¤šè„šæ‰‹æ¶å·¥å…·ã€‚controller-runtime åº“å¯¹ client-go åº“è¿›ä¸€æ­¥å°è£…ã€‚client-go æ›´åº•å±‚ã€‚ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ client-go å†™æ§åˆ¶å™¨ï¼Œè¯¦è§ <a href=https://github.com/kubernetes/sample-controller/blob/master/main.go>sample-controller</a> æºç ã€‚é€šå¸¸ä½¿ç”¨ controller-runtime æ›´å¤šã€‚</p>
<table>
<thead>
<tr>
<th>Informer</th>
<th>SharedIndexInformer</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>import toolscache "k8s.io/client-go/tools/cache"</code></strong></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>AddEventHandler(handler toolscache.ResourceEventHandler)</code></td>
<td><code>AddEventHandler(handler ResourceEventHandler)</code></td>
<td>å‚è€ƒ AddEventHandlerWithResyncPeriod</td>
</tr>
<tr>
<td><code>AddEventHandlerWithResyncPeriod(handler toolscache.ResourceEventHandler, resyncPeriod time.Duration)</code></td>
<td><code>AddEventHandlerWithResyncPeriod(handler ResourceEventHandler, resyncPeriod time.Duration)</code></td>
<td>æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ã€‚åœ¨ Informer å¯åŠ¨ï¼ˆä¹Ÿå³ Controller å¯åŠ¨æ—¶ï¼‰æ—¶ä¼šè¢«è°ƒç”¨</td>
</tr>
<tr>
<td><code>AddIndexers(indexers toolscache.Indexers) error</code></td>
<td><code>AddIndexers(indexers Indexers) error</code></td>
<td>æ·»åŠ ç´¢å¼•å™¨</td>
</tr>
<tr>
<td></td>
<td><code>GetIndexer() Indexer</code></td>
<td>è¿”å›å¸¦ç´¢å¼•ç¼“å­˜</td>
</tr>
<tr>
<td></td>
<td><code>GetStore() Store</code></td>
<td>è¿”å›ï¼ˆå¸¦ç´¢å¼•ï¼‰ç¼“å­˜ï¼Œå®ç°ä¸ŠåŒ <a href=https://github.com/kubernetes/client-go/blob/v0.22.1/tools/cache/shared_informer.go#L433-L439>GetIndexer()</a></td>
</tr>
<tr>
<td></td>
<td><code>GetController() Controller</code></td>
<td>æœªå®ç°åŠŸèƒ½çš„ç©ºæ–¹æ³•ã€‚ç”±ä¸Šå±‚å°è£…å®ç°</td>
</tr>
<tr>
<td></td>
<td><code>Run(stopCh &lt;-chan struct{})</code></td>
<td>æœªå®ç° SharedInformer çš„å¯åŠ¨ã€‚ç”±ä¸Šå±‚å°è£…å®ç°</td>
</tr>
<tr>
<td><code>HasSynced() bool</code></td>
<td><code>HasSynced() bool</code></td>
<td>åŒä¸Š</td>
</tr>
<tr>
<td></td>
<td><code>LastSyncResourceVersion() string</code></td>
<td>åŒä¸Š</td>
</tr>
<tr>
<td></td>
<td><code>SetWatchErrorHandler(handler WatchErrorHandler) error</code></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id=indexer>Indexer</h2>
<p>Indexer æ˜¯<a href=https://github.com/kubernetes/client-go/blob/v0.22.1/tools/cache/index.go#L35>å¸¦ç´¢å¼•çš„ç¼“å­˜ Store</a>ã€‚Indexer æ¥å£çš„åº•å±‚å®ç°æ˜¯ <a href=https://github.com/kubernetes/client-go/blob/v0.22.1/tools/cache/thread_safe_store.go#L63>threadSafeMap</a>ã€‚threadSafeMap åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼šindexersã€indicesã€itemsï¼š</p>
<ol>
<li>indexersï¼šä¸€ç»„ç´¢å¼•å™¨ã€‚ç´¢å¼•å™¨è®¡ç®—ç”¨äºè®¡ç®—å¾…ä¿å­˜å¯¹è±¡çš„ç´¢å¼•ï¼›</li>
<li>indicesï¼šä¸€ç»„ç´¢å¼•ã€‚ç´¢å¼•è®°å½•ç´¢å¼•ä¸å¯¹è±¡çš„ ID æ˜ å°„ï¼›</li>
<li>itemsï¼šå®é™…ä¿å­˜å¯¹è±¡çš„å˜é‡ã€‚æ˜¯å¯¹è±¡ ID ä¸å¯¹è±¡çš„æ˜ å°„ã€‚</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// threadSafeMap implements ThreadSafeStore
</span><span class=c1></span><span class=kd>type</span> <span class=nx>threadSafeMap</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>lock</span>  <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
	<span class=nx>items</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span>

	<span class=c1>// indexers maps a name to an IndexFunc
</span><span class=c1></span>	<span class=nx>indexers</span> <span class=nx>Indexers</span>
	<span class=c1>// indices maps a name to an Index
</span><span class=c1></span>	<span class=nx>indices</span> <span class=nx>Indices</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=indexers>Indexers</h3>
<p>Indexers æ˜¯ç´¢å¼•å™¨ï¼Œç´¢å¼•å™¨çš„ IndexFunc å‡½æ•°æ¥å—ä¸€ä¸ª K8s èµ„æºå¯¹è±¡ï¼ˆå¦‚ Podï¼‰è®¡ç®—è¯¥å¯¹è±¡çš„ç´¢å¼•ã€‚æœ€å¸¸è§çš„æ˜¯æŒ‰ namespace å»ºç«‹ç´¢å¼•ï¼Œclient-go æä¾›äº†è¯¥è®¡ç®—å‡½æ•°ï¼š<a href=https://github.com/kubernetes/client-go/blob/v0.22.1/tools/cache/index.go#L86>MetaNamespaceIndexFunc</a>ã€‚ä¹Ÿå¯ä»¥è‡ªå®šä¹‰æŒ‰ node å»ºç«‹ç´¢å¼•ã€‚</p>
<p><img src=/images/k8s-operator-dev-part3-1.png alt=k8s-operator-dev-part3-1></p>
<h3 id=indices>Indices</h3>
<p>Indices æ˜¯çœŸæ­£æ‰€è°“çš„ç´¢å¼•ã€‚Indices æ˜¯ä¸€ç»„ç´¢å¼•ï¼Œæ¯ä¸ªç´¢å¼•è®°å½•ç´¢å¼•åï¼Œç´¢å¼•åä¸‹çš„ç´¢å¼•é”®å€¼ã€‚æ¯”å¦‚å¦‚ä¸‹å›¾ï¼Œä½¿ç”¨ namespace ä½œä¸ºç´¢å¼•ï¼Œnamespace æœ‰ defaultã€kube-system å’Œ istio-system ä¸‰ä¸ªã€‚default ä¸‹åˆæœ‰ä¸‰ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡ ID ä¸º nginx-xxxx-xxxã€‚å¯¹è±¡ ID çš„è®¡ç®—æ–¹å¼å®šä¹‰åœ¨ <a href=https://github.com/kubernetes/client-go/blob/v0.22.1/tools/cache/store.go#L269>KeyFunc</a>ï¼Œé»˜è®¤æ˜¯ <a href=https://github.com/kubernetes/client-go/blob/v0.22.1/tools/cache/store.go#L104>MetaNamespaceKeyFunc</a>ï¼Œè¿”å›å¯¹è±¡çš„ &lt;namespace>/&lt;name> ä½œä¸º IDï¼ˆè¿™é‡Œç§° Keyï¼‰ã€‚</p>
<p><img src=/images/k8s-operator-dev-part3-2.png alt=k8s-operator-dev-part3-2></p>
<h3 id=items>Items</h3>
<p>å®é™…å…ƒç´ ä¿å­˜åœ¨ Items ä¸­ã€‚Items æ˜¯å¯¹è±¡çš„ Key ä¸å¯¹è±¡å®ä¾‹çš„æ˜ å°„ã€‚</p>
<p><img src=/images/k8s-operator-dev-part3-3.png alt=k8s-operator-dev-part3-3></p>
<h3 id=ç¼“å­˜åŒæ­¥>ç¼“å­˜åŒæ­¥</h3>
<p>Indexer æ”¯æŒå¯¹ç´¢å¼•ä»¥åŠç¼“å­˜å…ƒç´ çš„ CRUDã€‚é‚£ä¹ˆç°åœ¨çš„é—®é¢˜æ˜¯ç¼“å­˜çš„æ•°æ®æ¥æºæ˜¯å“ªï¼ŸK8s æ§åˆ¶å™¨ä¸æ˜¯é€šè¿‡ Get/List è¯·æ±‚ç›´æ¥è®¿é—® kube-apiserverï¼Œè€Œæ˜¯é€šè¿‡ <a href=https://github.com/kubernetes/client-go/blob/v0.22.1/tools/cache/reflector.go#L254>ListAndWatch</a> æœºåˆ¶ï¼Œå…ˆé€šè¿‡ <a href=https://github.com/kubernetes/client-go/blob/v0.22.1/tools/cache/reflector.go#L277>List</a> è¯·æ±‚æ‹¿åˆ°è¯·æ±‚èµ„æºçš„ç‰ˆæœ¬ï¼ˆresourceVersionï¼‰ï¼Œç„¶åå†å‘é€ <a href=https://github.com/kubernetes/client-go/blob/v0.22.1/tools/cache/reflector.go#L414>Watch</a> è¯·æ±‚ï¼Œç›‘å¬èµ„æºè¯¥ç‰ˆæœ¬ä¹‹åçš„å˜åŒ–ã€‚ä¸‹ä¸€ç¯‡æˆ‘ä»¬è¯¦ç»†ä»‹ç» ListAndWatch æœºåˆ¶ã€‚</p>
</article>
</main>
<script>const repo='mivinci/hugo-theme-minima',issueTerm='pathname',theme=localStorage.theme?`github-${localStorage.theme}`:'preferred-color-scheme',script=document.createElement('script');script.src='https://utteranc.es/client.js',script.async=!0,script.crossOrigin='anonymous',script.setAttribute('repo',repo),script.setAttribute('issue-term',issueTerm),script.setAttribute('theme',theme),script.setAttribute('label','comment'),document.querySelector('main').appendChild(script)</script>
<footer class="mt-8 flex sm:flex-col-reverse justify-between items-center">
<p class="mt-0 text-sm">
Â© huanggze 2021 |
<a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> on
<a href=https://github.com/mivinci/hugo-theme-minima target=_blank rel="noopener noreferrer">Minima</a>
</p>
<p class="flex items-center mt-0">
<a class="icon mx-2" href=https://github.com/huanggze title=github><svg fill="#63636f" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
</a>
<a class="icon mx-2" href=/index.xml title=rss><svg fill="#63636f" t="1626591563876" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="1984" width="18" height="16"><path d="M128 768a128 128 0 100 256 128 128 0 000-256zM0 368v176c265.104.0 480 214.912 480 480h176c0-362.32-293.696-656-656-656zM0 0v176c468.336.0 848 379.664 848 848h176C1024 458.464 565.536.0.0.0z" p-id="1985"/></svg>
</a>
</p>
</footer>
</body>
</html>